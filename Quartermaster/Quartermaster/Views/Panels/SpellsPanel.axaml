<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="1100" d:DesignHeight="600"
             x:Class="Quartermaster.Views.Panels.SpellsPanel">

    <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}" Padding="20,20,20,20">
        <!-- Main layout: Spell Slot Table on left, Spell List on right -->
        <Grid ColumnDefinitions="Auto,*">

            <!-- LEFT COLUMN: Summary Tables + Known Spells List (scrollable) -->
            <ScrollViewer Grid.Column="0"
                          VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Disabled"
                          Margin="0,0,15,0">
                <StackPanel>
                    <!-- Known Spells Table (spontaneous casters only: Sorcerer, Bard) -->
                    <!-- Shows: current known / limit from cls_spkn_*.2da -->
                    <Border x:Name="SpellSlotTableBorder"
                        Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"
                        CornerRadius="4"
                        Padding="10"
                        MinWidth="180"
                        IsVisible="False"
                        AutomationProperties.AutomationId="KnownSpellsTableSection">
                    <StackPanel>
                        <TextBlock x:Name="SpellSlotTableTitle"
                                   Text="Known Spells"
                                   FontWeight="SemiBold"
                                   FontSize="{DynamicResource FontSizeMedium}"
                                   Margin="0,0,0,10"/>
                        <!-- Dynamic table grid will be added here -->
                        <Grid x:Name="SpellSlotTableGrid">
                            <!-- Columns and rows populated dynamically based on spontaneous caster classes -->
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- Memorized Spells Table (prepared casters: Wizard, Cleric, Druid, etc.) -->
                <!-- Shows: current memorized / slots from cls_spgn_*.2da -->
                <Border x:Name="MemorizedSpellsTableBorder"
                        Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"
                        CornerRadius="4"
                        Padding="10"
                        Margin="0,10,0,0"
                        MinWidth="180"
                        IsVisible="False"
                        AutomationProperties.AutomationId="MemorizedSpellsTableSection">
                    <StackPanel>
                        <TextBlock Text="Memorized Spells"
                                   FontWeight="SemiBold"
                                   FontSize="{DynamicResource FontSizeMedium}"
                                   Margin="0,0,0,10"/>
                        <!-- Dynamic table grid showing memorized spell counts by level -->
                        <Grid x:Name="MemorizedSpellsTableGrid">
                            <!-- Columns and rows populated dynamically -->
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- Known Spells List (all casters - detailed spell names) -->
                <Border x:Name="KnownSpellsListBorder"
                        Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"
                        CornerRadius="4"
                        Padding="10"
                        Margin="0,10,0,0"
                        MinWidth="180"
                        IsVisible="False"
                        AutomationProperties.AutomationId="KnownSpellsListSection">
                    <StackPanel>
                        <TextBlock Text="Spell List"
                                   FontWeight="SemiBold"
                                   FontSize="{DynamicResource FontSizeMedium}"
                                   Margin="0,0,0,10"/>
                        <!-- Spell names grouped by level - no max height, can grow -->
                        <StackPanel x:Name="KnownSpellsListPanel">
                            <!-- Dynamically populated with spell names grouped by level -->
                        </StackPanel>
                    </StackPanel>
                </Border>
            </StackPanel>
            </ScrollViewer>

            <!-- RIGHT COLUMN: Original spell panel content -->
            <Grid Grid.Column="1" RowDefinitions="Auto,Auto,Auto,*,Auto">
                <!-- Header -->
                <TextBlock Grid.Row="0"
                           Text="Spells"
                           FontSize="{DynamicResource FontSizeXLarge}"
                           FontWeight="Bold"/>

                <!-- Caster Class Selector - compact layout -->
                <Border Grid.Row="1"
                    Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"
                    CornerRadius="4"
                    Padding="8,6"
                    Margin="0,0,0,8">
                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <TextBlock Text="Caster Class"
                                   FontWeight="SemiBold"
                                   FontSize="{DynamicResource FontSizeSmall}"
                                   VerticalAlignment="Center"/>
                        <ComboBox x:Name="ClassComboBox"
                                  MinWidth="180"
                                  MaxWidth="350"
                                  AutomationProperties.AutomationId="SpellsClassComboBox"/>
                    </StackPanel>
                </Border>
                <!-- Hidden summary text - kept for automation compatibility but not displayed -->
                <TextBlock x:Name="SpellSlotSummaryText" IsVisible="False" AutomationProperties.AutomationId="SpellSlotSummary"/>

            <!-- Filter Toolbar - WrapPanel allows filters to flow to multiple lines on narrow screens -->
            <WrapPanel Grid.Row="2" Orientation="Horizontal" Margin="0,0,0,5">
                <!-- Search Box -->
                <Border Margin="0,0,10,5">
                    <Grid ColumnDefinitions="*,Auto" MinWidth="180" MaxWidth="250">
                        <TextBox x:Name="SearchTextBox"
                                 Watermark="Search spells..."
                                 AutomationProperties.AutomationId="SpellsSearchBox"/>
                        <Button Grid.Column="1"
                                x:Name="ClearSearchButton"
                                Content="✕"
                                Width="28" Height="28"
                                Margin="5,0,0,0"
                                ToolTip.Tip="Clear search"
                                AutomationProperties.AutomationId="SpellsClearSearch"/>
                    </Grid>
                </Border>

                <!-- Spell Level Filter -->
                <StackPanel Orientation="Horizontal" Spacing="5" Margin="0,0,10,5">
                    <TextBlock Text="Level:" VerticalAlignment="Center"/>
                    <ComboBox x:Name="LevelFilterComboBox"
                              SelectedIndex="0"
                              MinWidth="80"
                              AutomationProperties.AutomationId="SpellsLevelFilter">
                        <ComboBoxItem Content="All"/>
                        <ComboBoxItem Content="0"/>
                        <ComboBoxItem Content="1"/>
                        <ComboBoxItem Content="2"/>
                        <ComboBoxItem Content="3"/>
                        <ComboBoxItem Content="4"/>
                        <ComboBoxItem Content="5"/>
                        <ComboBoxItem Content="6"/>
                        <ComboBoxItem Content="7"/>
                        <ComboBoxItem Content="8"/>
                        <ComboBoxItem Content="9"/>
                    </ComboBox>
                </StackPanel>

                <!-- Spell School Filter -->
                <StackPanel Orientation="Horizontal" Spacing="5" Margin="0,0,10,5">
                    <TextBlock Text="School:" VerticalAlignment="Center"/>
                    <ComboBox x:Name="SchoolFilterComboBox"
                              SelectedIndex="0"
                              MinWidth="100"
                              AutomationProperties.AutomationId="SpellsSchoolFilter">
                        <ComboBoxItem Content="All"/>
                        <ComboBoxItem Content="Abjuration"/>
                        <ComboBoxItem Content="Conjuration"/>
                        <ComboBoxItem Content="Divination"/>
                        <ComboBoxItem Content="Enchantment"/>
                        <ComboBoxItem Content="Evocation"/>
                        <ComboBoxItem Content="Illusion"/>
                        <ComboBoxItem Content="Necromancy"/>
                        <ComboBoxItem Content="Transmutation"/>
                    </ComboBox>
                </StackPanel>

                <!-- Status Filter -->
                <StackPanel Orientation="Horizontal" Spacing="5" Margin="0,0,10,5">
                    <TextBlock Text="Status:" VerticalAlignment="Center"/>
                    <ComboBox x:Name="StatusFilterComboBox"
                              SelectedIndex="0"
                              MinWidth="90"
                              AutomationProperties.AutomationId="SpellsStatusFilter">
                        <ComboBoxItem Content="All"/>
                        <ComboBoxItem Content="Known"/>
                        <ComboBoxItem Content="Memorized"/>
                        <ComboBoxItem Content="Available"/>
                        <ComboBoxItem Content="Blocked"/>
                    </ComboBox>
                </StackPanel>

                <!-- Class Restrictions Toggle -->
                <CheckBox x:Name="IgnoreRestrictionsCheckBox"
                          Content="Ignore class restrictions"
                          VerticalAlignment="Center"
                          Margin="0,0,0,5"
                          ToolTip.Tip="When checked, all spells are available regardless of class spell lists. Useful for custom creatures."
                          AutomationProperties.AutomationId="SpellsIgnoreRestrictionsCheckbox"/>
            </WrapPanel>

            <!-- Spells List -->
            <Grid Grid.Row="3" RowDefinitions="Auto,*,Auto,Auto">
                <!-- Header Row -->
                <Border Grid.Row="0"
                        Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"
                        BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                        BorderThickness="1,1,1,0"
                        CornerRadius="4,4,0,0"
                        Padding="10,8,25,8">
                    <Grid ColumnDefinitions="32,35,70,*,60,100,80,80">
                        <TextBlock Grid.Column="0" Text="" FontWeight="SemiBold" FontSize="{DynamicResource FontSizeSmall}" HorizontalAlignment="Center"/>
                        <TextBlock Grid.Column="1" Text="K" FontWeight="SemiBold" FontSize="{DynamicResource FontSizeSmall}" HorizontalAlignment="Center"
                                   ToolTip.Tip="Known - Spell is in spellbook/learned"/>
                        <TextBlock Grid.Column="2" Text="Mem" FontWeight="SemiBold" FontSize="{DynamicResource FontSizeSmall}" HorizontalAlignment="Center"
                                   x:Name="MemorizedHeader"
                                   ToolTip.Tip="Memorized - Number of times spell is prepared (use +/- to adjust)"/>
                        <TextBlock Grid.Column="3" Text="Spell Name" FontWeight="SemiBold" FontSize="{DynamicResource FontSizeSmall}"/>
                        <TextBlock Grid.Column="4" Text="Level" FontWeight="SemiBold" FontSize="{DynamicResource FontSizeSmall}" HorizontalAlignment="Center"/>
                        <TextBlock Grid.Column="5" Text="School" FontWeight="SemiBold" FontSize="{DynamicResource FontSizeSmall}" HorizontalAlignment="Center"/>
                        <TextBlock Grid.Column="6" Text="Innate" FontWeight="SemiBold" FontSize="{DynamicResource FontSizeSmall}" HorizontalAlignment="Center"
                                   ToolTip.Tip="Innate Spell Level"/>
                        <TextBlock Grid.Column="7" Text="Status" FontWeight="SemiBold" FontSize="{DynamicResource FontSizeSmall}" HorizontalAlignment="Center"/>
                    </Grid>
                </Border>

                <!-- Virtualized Spell Items using ListBox -->
                <ListBox Grid.Row="1"
                         x:Name="SpellsList"
                         BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                         BorderThickness="1,0,1,1"
                         Background="Transparent"
                         SelectionMode="Single"
                         AutomationProperties.AutomationId="SpellsListItems">
                    <!-- Remove default ListBoxItem padding/margin for tight row spacing -->
                    <ListBox.ItemContainerTheme>
                        <ControlTheme TargetType="ListBoxItem" BasedOn="{StaticResource {x:Type ListBoxItem}}">
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="Margin" Value="0"/>
                            <Setter Property="MinHeight" Value="0"/>
                        </ControlTheme>
                    </ListBox.ItemContainerTheme>
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Border Background="{Binding RowBackground}"
                                    Padding="10,4,10,4"
                                    ToolTip.Tip="{Binding Description}">
                                <Grid ColumnDefinitions="32,35,70,*,60,100,80,80">
                                    <!-- Icon -->
                                    <Image Grid.Column="0"
                                           Source="{Binding IconBitmap}"
                                           Width="24" Height="24"
                                           Stretch="Uniform"
                                           IsVisible="{Binding HasGameIcon}"
                                           VerticalAlignment="Center"
                                           HorizontalAlignment="Center"/>

                                    <!-- Known checkbox -->
                                    <CheckBox Grid.Column="1"
                                              IsChecked="{Binding IsKnown}"
                                              IsEnabled="{Binding CanToggleKnown}"
                                              HorizontalAlignment="Center"
                                              VerticalAlignment="Center"
                                              ToolTip.Tip="{Binding KnownTooltip}"
                                              AutomationProperties.AutomationId="SpellKnownCheckbox"/>

                                    <!-- Memorized count with +/- buttons -->
                                    <StackPanel Grid.Column="2"
                                                Orientation="Horizontal"
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center"
                                                Spacing="2"
                                                IsVisible="{Binding !IsSpontaneousCaster}">
                                        <Button Content="-"
                                                Width="22" Height="22"
                                                Padding="0"
                                                FontSize="{DynamicResource FontSizeNormal}"
                                                FontWeight="Bold"
                                                Click="OnDecrementMemorizedClick"
                                                IsEnabled="{Binding CanDecrementMemorized}"
                                                ToolTip.Tip="Remove one memorization"
                                                AutomationProperties.AutomationId="SpellMemorizedMinus"/>
                                        <TextBlock Text="{Binding MemorizedCountDisplay}"
                                                   Width="24"
                                                   TextAlignment="Center"
                                                   VerticalAlignment="Center"
                                                   FontSize="{DynamicResource FontSizeNormal}"
                                                   FontWeight="Bold"
                                                   Foreground="{Binding MemorizedCountColor}"/>
                                        <Button Content="+"
                                                Width="22" Height="22"
                                                Padding="0"
                                                FontSize="{DynamicResource FontSizeNormal}"
                                                FontWeight="Bold"
                                                Click="OnIncrementMemorizedClick"
                                                IsEnabled="{Binding CanIncrementMemorized}"
                                                ToolTip.Tip="Add one memorization"
                                                AutomationProperties.AutomationId="SpellMemorizedPlus"/>
                                    </StackPanel>
                                    <!-- Spontaneous casters don't memorize - show dash -->
                                    <TextBlock Grid.Column="2"
                                               Text="—"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"
                                               Foreground="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                                               IsVisible="{Binding IsSpontaneousCaster}"
                                               ToolTip.Tip="Spontaneous casters don't memorize spells"/>

                                    <!-- Spell Name -->
                                    <TextBlock Grid.Column="3"
                                               Text="{Binding SpellName}"
                                               VerticalAlignment="Center"
                                               FontSize="{DynamicResource FontSizeNormal}"
                                               Opacity="{Binding TextOpacity}"/>

                                    <!-- Spell Level -->
                                    <TextBlock Grid.Column="4"
                                               Text="{Binding SpellLevelDisplay}"
                                               FontSize="{DynamicResource FontSizeSmall}"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"/>

                                    <!-- School -->
                                    <TextBlock Grid.Column="5"
                                               Text="{Binding SchoolName}"
                                               FontSize="{DynamicResource FontSizeSmall}"
                                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"/>

                                    <!-- Innate Level -->
                                    <TextBlock Grid.Column="6"
                                               Text="{Binding InnateLevelDisplay}"
                                               FontSize="{DynamicResource FontSizeSmall}"
                                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"/>

                                    <!-- Status -->
                                    <TextBlock Grid.Column="7"
                                               Text="{Binding StatusText}"
                                               FontSize="{DynamicResource FontSizeSmall}"
                                               Foreground="{Binding StatusColor}"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"/>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>

                <TextBlock Grid.Row="2"
                           x:Name="NoSpellsText"
                           Text="No spells match the current filter"
                           FontStyle="Italic"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                           IsVisible="False"
                           Margin="15,15"
                           AutomationProperties.AutomationId="NoSpellsText"/>

                <TextBlock Grid.Row="3"
                           x:Name="LoadingText"
                           Text="Loading spells..."
                           FontStyle="Italic"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                           IsVisible="False"
                           Margin="15,15"/>
            </Grid>

            <!-- Footer with Meta-Magic and Actions -->
            <Grid Grid.Row="4" ColumnDefinitions="*,Auto" Margin="0,10,0,0">
                <!-- Meta-Magic Expander (placeholder) -->
                <Expander Grid.Column="0"
                          Header="Meta-Magic Feats"
                          IsExpanded="False"
                          x:Name="MetaMagicExpander"
                          AutomationProperties.AutomationId="MetaMagicExpander">
                    <Border BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                            BorderThickness="1"
                            CornerRadius="4"
                            Padding="15"
                            MaxHeight="120">
                        <StackPanel>
                            <TextBlock Text="Meta-magic display will show applied feats that modify spell slots."
                                       FontStyle="Italic"
                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                                       TextWrapping="Wrap"/>
                            <TextBlock Text="(Read-only in this version)"
                                       FontStyle="Italic"
                                       FontSize="{DynamicResource FontSizeSmall}"
                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                                       Margin="0,5,0,0"/>
                        </StackPanel>
                    </Border>
                </Expander>

                <!-- Spell Actions -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Top">
                    <Button x:Name="ClearSpellListButton"
                            Content="Clear All"
                            ToolTip.Tip="Clear all known and memorized spells for selected class"
                            AutomationProperties.AutomationId="ClearSpellListButton"/>
                    <Button Content="Save List"
                            IsEnabled="False"
                            ToolTip.Tip="Save class spell list (not yet implemented)"
                            AutomationProperties.AutomationId="SaveSpellListButton"/>
                    <Button Content="Load List"
                            IsEnabled="False"
                            ToolTip.Tip="Load class spell list (not yet implemented)"
                            AutomationProperties.AutomationId="LoadSpellListButton"/>
                </StackPanel>
            </Grid>
            </Grid>
        </Grid>
    </Border>
</UserControl>
