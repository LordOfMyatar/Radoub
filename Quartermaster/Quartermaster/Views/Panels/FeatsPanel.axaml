<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="700" d:DesignHeight="600"
             x:Class="Quartermaster.Views.Panels.FeatsPanel">

    <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}" Padding="20,20,20,20">
        <!-- Main layout: Assigned Feats List on left, Feat Browser on right -->
        <Grid ColumnDefinitions="Auto,*">

            <!-- LEFT COLUMN: Assigned Feats by Class -->
            <Border Grid.Column="0"
                    x:Name="AssignedFeatsListBorder"
                    Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"
                    CornerRadius="4"
                    Padding="10"
                    Margin="0,0,15,0"
                    MinWidth="180"
                    MaxHeight="500"
                    IsVisible="False"
                    AutomationProperties.AutomationId="AssignedFeatsListSection">
                <StackPanel>
                    <TextBlock Text="Assigned Feats"
                               FontWeight="SemiBold"
                               FontSize="{DynamicResource FontSizeNormal}"
                               Margin="0,0,0,10"/>
                    <!-- Scrollable list of assigned feats grouped by class -->
                    <ScrollViewer MaxHeight="450" VerticalScrollBarVisibility="Auto">
                        <StackPanel x:Name="AssignedFeatsListPanel">
                            <!-- Dynamically populated with feat names grouped by class -->
                        </StackPanel>
                    </ScrollViewer>
                </StackPanel>
            </Border>

            <!-- RIGHT COLUMN: Original feat panel content -->
            <Grid Grid.Column="1" RowDefinitions="Auto,Auto,Auto,*,Auto">
            <!-- Header -->
            <TextBlock Grid.Row="0"
                       Text="Feats"
                       FontSize="{DynamicResource FontSizeXLarge}"
                       FontWeight="Bold"/>

            <!-- Feats Summary -->
            <TextBlock Grid.Row="1"
                       x:Name="FeatsSummaryText"
                       Text="0 feats assigned"
                       FontSize="{DynamicResource FontSizeSmall}"
                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                       Margin="0,5,0,10"/>

            <!-- Search and Filter Controls -->
            <WrapPanel Grid.Row="2" Orientation="Horizontal" Margin="0,0,0,10">
                <!-- Search Box -->
                <Grid ColumnDefinitions="*,Auto" Margin="0,0,15,8" MinWidth="200">
                    <TextBox x:Name="SearchTextBox"
                             Watermark="Search feats..."
                             AutomationProperties.AutomationId="FeatsSearchBox"/>
                    <Button Grid.Column="1"
                            x:Name="ClearSearchButton"
                            Content="âœ•"
                            Width="28" Height="28"
                            Margin="5,0,0,0"
                            ToolTip.Tip="Clear search"
                            AutomationProperties.AutomationId="FeatsClearSearch"/>
                </Grid>

                <!-- Category Filter -->
                <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,0,15,8">
                    <TextBlock Text="Category:" VerticalAlignment="Center"/>
                    <ComboBox x:Name="CategoryFilterComboBox"
                              SelectedIndex="0"
                              MinWidth="120"
                              AutomationProperties.AutomationId="FeatsCategoryFilter">
                        <ComboBoxItem Content="All Categories"/>
                        <ComboBoxItem Content="Combat"/>
                        <ComboBoxItem Content="Active Combat"/>
                        <ComboBoxItem Content="Defensive"/>
                        <ComboBoxItem Content="Magical"/>
                        <ComboBoxItem Content="Class/Racial"/>
                        <ComboBoxItem Content="Other"/>
                    </ComboBox>
                </StackPanel>

                <!-- Status Filter (checkboxes for multi-select) -->
                <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,0,0,8">
                    <TextBlock Text="Status:" VerticalAlignment="Center"/>
                    <CheckBox x:Name="ShowAssignedCheckBox"
                              Content="Assigned"
                              IsChecked="True"
                              VerticalAlignment="Center"
                              AutomationProperties.AutomationId="FeatsShowAssigned"/>
                    <CheckBox x:Name="ShowGrantedCheckBox"
                              Content="Granted"
                              IsChecked="True"
                              VerticalAlignment="Center"
                              AutomationProperties.AutomationId="FeatsShowGranted"/>
                    <CheckBox x:Name="ShowAvailableCheckBox"
                              Content="Available"
                              IsChecked="True"
                              VerticalAlignment="Center"
                              AutomationProperties.AutomationId="FeatsShowAvailable"/>
                    <CheckBox x:Name="ShowPrereqsUnmetCheckBox"
                              Content="Prereqs Unmet"
                              IsChecked="True"
                              VerticalAlignment="Center"
                              AutomationProperties.AutomationId="FeatsShowPrereqsUnmet"/>
                    <CheckBox x:Name="ShowUnavailableCheckBox"
                              Content="Unavailable"
                              IsChecked="False"
                              VerticalAlignment="Center"
                              AutomationProperties.AutomationId="FeatsShowUnavailable"/>
                </StackPanel>
            </WrapPanel>

            <!-- Feats List -->
            <Grid Grid.Row="3" RowDefinitions="Auto,*,Auto,Auto">
                <!-- Header Row -->
                <Border Grid.Row="0"
                        Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"
                        BorderBrush="{DynamicResource SystemBaseMediumLowColor}"
                        BorderThickness="1,1,1,0"
                        CornerRadius="4,4,0,0"
                        Padding="10,8,25,8">
                    <Grid ColumnDefinitions="32,35,*,120,100">
                        <TextBlock Grid.Column="0" Text="" FontWeight="SemiBold" FontSize="{DynamicResource FontSizeSmall}"/>
                        <TextBlock Grid.Column="1" Text="Has" FontWeight="SemiBold" FontSize="{DynamicResource FontSizeSmall}" HorizontalAlignment="Center"
                                   ToolTip.Tip="Feat is assigned to creature"/>
                        <TextBlock Grid.Column="2" Text="Feat Name" FontWeight="SemiBold" FontSize="{DynamicResource FontSizeSmall}"/>
                        <TextBlock Grid.Column="3" Text="Category" FontWeight="SemiBold" FontSize="{DynamicResource FontSizeSmall}" HorizontalAlignment="Center"/>
                        <TextBlock Grid.Column="4" Text="Status" FontWeight="SemiBold" FontSize="{DynamicResource FontSizeSmall}" HorizontalAlignment="Center"/>
                    </Grid>
                </Border>

                <!-- Virtualized Feats Items using ListBox -->
                <ListBox Grid.Row="1"
                         x:Name="FeatsList"
                         BorderBrush="{DynamicResource SystemBaseMediumLowColor}"
                         BorderThickness="1,0,1,1"
                         Background="Transparent"
                         SelectionMode="Single">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Border Background="{Binding RowBackground}"
                                    Padding="10,6,10,6"
                                    ToolTip.Tip="{Binding Description}">
                                <Grid ColumnDefinitions="32,35,*,120,100">
                                    <!-- Icon -->
                                    <Image Grid.Column="0"
                                           Source="{Binding IconBitmap}"
                                           Width="24" Height="24"
                                           Stretch="Uniform"
                                           IsVisible="{Binding HasGameIcon}"
                                           VerticalAlignment="Center"
                                           HorizontalAlignment="Center"/>

                                    <!-- Assigned Checkbox -->
                                    <CheckBox Grid.Column="1"
                                              IsChecked="{Binding IsAssigned}"
                                              IsEnabled="{Binding CanToggle}"
                                              HorizontalAlignment="Center"
                                              VerticalAlignment="Center"
                                              ToolTip.Tip="{Binding AssignedTooltip}"
                                              AutomationProperties.AutomationId="FeatAssignedCheckbox"/>

                                    <!-- Feat Name -->
                                    <TextBlock Grid.Column="2"
                                               Text="{Binding FeatName}"
                                               VerticalAlignment="Center"
                                               FontSize="{DynamicResource FontSizeNormal}"
                                               Opacity="{Binding TextOpacity}"/>

                                    <!-- Category -->
                                    <TextBlock Grid.Column="3"
                                               Text="{Binding CategoryName}"
                                               FontSize="{DynamicResource FontSizeSmall}"
                                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"/>

                                    <!-- Status -->
                                    <TextBlock Grid.Column="4"
                                               Text="{Binding StatusText}"
                                               FontSize="{DynamicResource FontSizeSmall}"
                                               Foreground="{Binding StatusColor}"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"/>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>

                <TextBlock Grid.Row="2"
                           x:Name="NoFeatsText"
                           Text="No feats match the current filter"
                           FontStyle="Italic"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                           IsVisible="False"
                           Margin="15,15"/>

                <TextBlock Grid.Row="3"
                           x:Name="LoadingText"
                           Text="Loading feats..."
                           FontStyle="Italic"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                           IsVisible="False"
                           Margin="15,15"/>
            </Grid>

            <!-- Footer with Special Abilities -->
            <Expander Grid.Row="4"
                      Header="Special Abilities (Spell-Like)"
                      Margin="0,10,0,0"
                      IsExpanded="False"
                      x:Name="SpecialAbilitiesExpander">
                <Border BorderBrush="{DynamicResource SystemBaseMediumLowColor}"
                        BorderThickness="1"
                        CornerRadius="4"
                        Padding="15"
                        MaxHeight="250">
                    <Grid RowDefinitions="*,Auto">
                        <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto">
                            <StackPanel>
                                <ItemsControl x:Name="SpecialAbilitiesList">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Grid ColumnDefinitions="*,70,60,30" Margin="0,3">
                                                <!-- Spell Name -->
                                                <TextBlock Grid.Column="0"
                                                           Text="{Binding AbilityName}"
                                                           VerticalAlignment="Center"/>
                                                <!-- Caster Level -->
                                                <NumericUpDown Grid.Column="1"
                                                               Value="{Binding CasterLevel, Mode=TwoWay}"
                                                               Minimum="1" Maximum="40" Increment="1"
                                                               FormatString="CL 0"
                                                               FontSize="{DynamicResource FontSizeSmall}"
                                                               VerticalAlignment="Center"
                                                               AutomationProperties.AutomationId="AbilityCasterLevel"/>
                                                <!-- Flags (Unlimited checkbox) -->
                                                <CheckBox Grid.Column="2"
                                                          IsChecked="{Binding IsUnlimited, Mode=TwoWay}"
                                                          Content="Unl"
                                                          ToolTip.Tip="Unlimited uses per day"
                                                          FontSize="{DynamicResource FontSizeSmall}"
                                                          VerticalAlignment="Center"
                                                          AutomationProperties.AutomationId="AbilityUnlimited"/>
                                                <!-- Remove Button -->
                                                <Button Grid.Column="3"
                                                        Content="X"
                                                        ToolTip.Tip="Remove ability"
                                                        Command="{Binding RemoveCommand}"
                                                        FontSize="{DynamicResource FontSizeSmall}"
                                                        Padding="4,2"
                                                        VerticalAlignment="Center"
                                                        AutomationProperties.AutomationId="RemoveAbilityButton"/>
                                            </Grid>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>

                                <TextBlock x:Name="NoAbilitiesText"
                                           Text="No special abilities"
                                           FontStyle="Italic"
                                           Foreground="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                                           IsVisible="True"/>
                            </StackPanel>
                        </ScrollViewer>

                        <!-- Add Button -->
                        <Button Grid.Row="1" x:Name="AddAbilityButton"
                                Content="Add Ability..."
                                HorizontalAlignment="Left"
                                Margin="0,10,0,0"
                                AutomationProperties.AutomationId="AddAbilityButton"/>
                    </Grid>
                </Border>
            </Expander>
            </Grid>
        </Grid>
    </Border>
</UserControl>
