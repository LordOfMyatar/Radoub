<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="700" d:DesignHeight="600"
             x:Class="Quartermaster.Views.Panels.FeatsPanel">

    <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}" Padding="20,20,20,20">
        <Grid RowDefinitions="Auto,Auto,Auto,*,Auto">
            <!-- Header -->
            <TextBlock Grid.Row="0"
                       Text="Feats"
                       FontSize="20"
                       FontWeight="Bold"/>

            <!-- Feats Summary -->
            <TextBlock Grid.Row="1"
                       x:Name="FeatsSummaryText"
                       Text="0 feats assigned"
                       FontSize="12"
                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                       Margin="0,5,0,10"/>

            <!-- Search and Filter Controls -->
            <Grid Grid.Row="2" ColumnDefinitions="*,Auto,Auto" Margin="0,0,0,10">
                <!-- Search Box -->
                <Grid Grid.Column="0" ColumnDefinitions="*,Auto">
                    <TextBox x:Name="SearchTextBox"
                             Watermark="Search feats..."
                             MinWidth="200"
                             AutomationProperties.AutomationId="FeatsSearchBox"/>
                    <Button Grid.Column="1"
                            x:Name="ClearSearchButton"
                            Content="✕"
                            Width="28" Height="28"
                            Margin="5,0,0,0"
                            ToolTip.Tip="Clear search"
                            AutomationProperties.AutomationId="FeatsClearSearch"/>
                </Grid>

                <!-- Category Filter -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="10" Margin="15,0,0,0">
                    <TextBlock Text="Filter:" VerticalAlignment="Center"/>
                    <ComboBox x:Name="CategoryFilterComboBox"
                              SelectedIndex="0"
                              MinWidth="150"
                              AutomationProperties.AutomationId="FeatsCategoryFilter">
                        <ComboBoxItem Content="All Feats"/>
                        <ComboBoxItem Content="Combat"/>
                        <ComboBoxItem Content="Active Combat"/>
                        <ComboBoxItem Content="Defensive"/>
                        <ComboBoxItem Content="Magical"/>
                        <ComboBoxItem Content="Class/Racial"/>
                        <ComboBoxItem Content="Other"/>
                        <ComboBoxItem Content="Assigned Only"/>
                        <ComboBoxItem Content="Granted Only"/>
                        <ComboBoxItem Content="Unassigned Only"/>
                        <ComboBoxItem Content="Available Only"/>
                        <ComboBoxItem Content="Unavailable Only"/>
                        <ComboBoxItem Content="Prereqs Met"/>
                        <ComboBoxItem Content="Prereqs Unmet"/>
                        <ComboBoxItem Content="Has Prereqs"/>
                    </ComboBox>
                </StackPanel>

                <!-- Legend -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8" Margin="15,0,0,0">
                    <StackPanel Orientation="Horizontal" Spacing="2">
                        <TextBlock Text="✓" Foreground="Green" FontSize="11" FontWeight="Bold" VerticalAlignment="Center"/>
                        <TextBlock Text="Has" FontSize="10" VerticalAlignment="Center"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="2">
                        <TextBlock Text="★" Foreground="Gold" FontSize="11" VerticalAlignment="Center"/>
                        <TextBlock Text="Granted" FontSize="10" VerticalAlignment="Center"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="2">
                        <TextBlock Text="⚠" Foreground="Orange" FontSize="11" VerticalAlignment="Center"/>
                        <TextBlock Text="Unmet" FontSize="10" VerticalAlignment="Center"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="2">
                        <TextBlock Text="✗" Foreground="Gray" FontSize="11" VerticalAlignment="Center"/>
                        <TextBlock Text="N/A" FontSize="10" VerticalAlignment="Center"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                    </StackPanel>
                </StackPanel>
            </Grid>

            <!-- Feats List -->
            <Grid Grid.Row="3" RowDefinitions="Auto,*,Auto,Auto">
                <!-- Header Row -->
                <Border Grid.Row="0"
                        Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"
                        BorderBrush="{DynamicResource SystemBaseMediumLowColor}"
                        BorderThickness="1,1,1,0"
                        CornerRadius="4,4,0,0"
                        Padding="10,8,25,8">
                    <Grid ColumnDefinitions="32,30,*,120,80,60">
                        <TextBlock Grid.Column="0" Text="" FontWeight="SemiBold" FontSize="11"/>
                        <TextBlock Grid.Column="1" Text="" FontWeight="SemiBold" FontSize="11"/>
                        <TextBlock Grid.Column="2" Text="Feat Name" FontWeight="SemiBold" FontSize="11"/>
                        <TextBlock Grid.Column="3" Text="Category" FontWeight="SemiBold" FontSize="11" HorizontalAlignment="Center"/>
                        <TextBlock Grid.Column="4" Text="Status" FontWeight="SemiBold" FontSize="11" HorizontalAlignment="Center"/>
                        <TextBlock Grid.Column="5" Text="" FontWeight="SemiBold" FontSize="11" HorizontalAlignment="Center"/>
                    </Grid>
                </Border>

                <!-- Virtualized Feats Items using ListBox -->
                <ListBox Grid.Row="1"
                         x:Name="FeatsList"
                         BorderBrush="{DynamicResource SystemBaseMediumLowColor}"
                         BorderThickness="1,0,1,1"
                         Background="Transparent"
                         SelectionMode="Single">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Border Background="{Binding RowBackground}"
                                    Padding="10,6,10,6"
                                    ToolTip.Tip="{Binding Description}">
                                <Grid ColumnDefinitions="32,30,*,120,80,60">
                                    <!-- Icon -->
                                    <Image Grid.Column="0"
                                           Source="{Binding IconBitmap}"
                                           Width="24" Height="24"
                                           Stretch="Uniform"
                                           IsVisible="{Binding HasGameIcon}"
                                           VerticalAlignment="Center"
                                           HorizontalAlignment="Center"/>

                                    <!-- Status Indicator -->
                                    <TextBlock Grid.Column="1"
                                               Text="{Binding StatusIndicator}"
                                               Foreground="{Binding StatusColor}"
                                               FontSize="12"
                                               FontWeight="Bold"
                                               VerticalAlignment="Center"
                                               HorizontalAlignment="Center"/>

                                    <!-- Feat Name -->
                                    <TextBlock Grid.Column="2"
                                               Text="{Binding FeatName}"
                                               VerticalAlignment="Center"
                                               FontSize="13"
                                               Opacity="{Binding TextOpacity}"/>

                                    <!-- Category -->
                                    <TextBlock Grid.Column="3"
                                               Text="{Binding CategoryName}"
                                               FontSize="11"
                                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"/>

                                    <!-- Assigned/Granted Status -->
                                    <TextBlock Grid.Column="4"
                                               Text="{Binding StatusText}"
                                               FontSize="11"
                                               Foreground="{Binding StatusColor}"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"/>

                                    <!-- Add/Remove Buttons -->
                                    <StackPanel Grid.Column="5" Orientation="Horizontal" Spacing="4" HorizontalAlignment="Center">
                                        <Button Content="+"
                                                Width="24" Height="24"
                                                FontSize="14" FontWeight="Bold"
                                                Padding="0"
                                                IsVisible="{Binding CanAdd}"
                                                Tag="{Binding FeatId}"
                                                ToolTip.Tip="Add feat"
                                                AutomationProperties.AutomationId="AddFeatButton"/>
                                        <Button Content="−"
                                                Width="24" Height="24"
                                                FontSize="14" FontWeight="Bold"
                                                Padding="0"
                                                IsVisible="{Binding CanRemove}"
                                                Tag="{Binding FeatId}"
                                                ToolTip.Tip="Remove feat"
                                                AutomationProperties.AutomationId="RemoveFeatButton"/>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>

                <TextBlock Grid.Row="2"
                           x:Name="NoFeatsText"
                           Text="No feats match the current filter"
                           FontStyle="Italic"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                           IsVisible="False"
                           Margin="15,15"/>

                <TextBlock Grid.Row="3"
                           x:Name="LoadingText"
                           Text="Loading feats..."
                           FontStyle="Italic"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                           IsVisible="False"
                           Margin="15,15"/>
            </Grid>

            <!-- Footer with Special Abilities -->
            <Expander Grid.Row="4"
                      Header="Special Abilities"
                      Margin="0,10,0,0"
                      IsExpanded="False"
                      x:Name="SpecialAbilitiesExpander">
                <Border BorderBrush="{DynamicResource SystemBaseMediumLowColor}"
                        BorderThickness="1"
                        CornerRadius="4"
                        Padding="15"
                        MaxHeight="150">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel>
                            <ItemsControl x:Name="SpecialAbilitiesList">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid ColumnDefinitions="*,Auto" Margin="0,3">
                                            <TextBlock Grid.Column="0"
                                                       Text="{Binding AbilityName}"
                                                       VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="1"
                                                       Text="{Binding CasterLevelDisplay}"
                                                       FontSize="11"
                                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                                       VerticalAlignment="Center"/>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <TextBlock x:Name="NoAbilitiesText"
                                       Text="No special abilities"
                                       FontStyle="Italic"
                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                                       IsVisible="True"/>
                        </StackPanel>
                    </ScrollViewer>
                </Border>
            </Expander>
        </Grid>
    </Border>
</UserControl>
