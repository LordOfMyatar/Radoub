name: Privacy Check

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  check-privacy:
    runs-on: ubuntu-latest
    name: Check for Privacy Leaks

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for hardcoded paths
        run: |
          echo "Checking for hardcoded user paths..."

          # Patterns that should NOT appear in code
          PRIVACY_PATTERNS=(
            'C:\\Users\\[A-Za-z]+'
            'C:/Users/[A-Za-z]+'
            '/Users/[A-Za-z]+/'
            '/home/[a-z]+/'
            'C:\\\\Users\\\\[A-Za-z]+'
          )

          # Files to check (exclude NonPublic, test outputs, git metadata)
          FILES=$(git ls-files | grep -vE '(^NonPublic/|^\.git/|\.png$|\.jpg$|\.ico$|\.dll$|\.exe$)')

          FOUND_ISSUES=0

          for pattern in "${PRIVACY_PATTERNS[@]}"; do
            echo ""
            echo "Checking pattern: $pattern"

            # Use grep with Perl regex for better pattern matching
            if echo "$FILES" | xargs grep -nE "$pattern" 2>/dev/null; then
              echo "❌ Found hardcoded path matching pattern: $pattern"
              FOUND_ISSUES=1
            fi
          done

          if [ $FOUND_ISSUES -eq 1 ]; then
            echo ""
            echo "========================================="
            echo "❌ Privacy Check Failed"
            echo "========================================="
            echo "Found hardcoded user paths in code."
            echo ""
            echo "Please replace with:"
            echo "  - Use ~ for home directory"
            echo "  - Use Environment.GetFolderPath() in C#"
            echo "  - Use relative paths where possible"
            echo "  - Use PathHelper.SanitizePathForDisplay() for logging"
            echo ""
            exit 1
          fi

          echo ""
          echo "✅ Privacy check passed - no hardcoded paths found"

      - name: Check for over-logging sensitive data
        run: |
          echo "Checking for over-logging patterns..."

          # Patterns that might indicate over-logging
          OVERLOG_PATTERNS=(
            'UnifiedLogger\.Log.*Environment\.UserName'
            'Console\.WriteLine.*Environment\.UserName'
            'Debug\.WriteLine.*Environment\.UserName'
            'UnifiedLogger\.Log.*Environment\.MachineName'
            'Console\.WriteLine.*Environment\.MachineName'
          )

          FILES=$(git ls-files '*.cs' | grep -vE '^NonPublic/')

          FOUND_ISSUES=0

          for pattern in "${OVERLOG_PATTERNS[@]}"; do
            echo "Checking pattern: $pattern"

            if echo "$FILES" | xargs grep -nE "$pattern" 2>/dev/null; then
              echo "⚠️  Found potential over-logging: $pattern"
              FOUND_ISSUES=1
            fi
          done

          if [ $FOUND_ISSUES -eq 1 ]; then
            echo ""
            echo "========================================="
            echo "⚠️  Over-Logging Warning"
            echo "========================================="
            echo "Found logging that may expose sensitive information."
            echo "Review these logs to ensure they're necessary."
            echo ""
            exit 1
          fi

          echo "✅ Over-logging check passed"

      - name: Check for personal identifiers
        run: |
          echo "Checking for personal identifiers..."

          # Check for common name patterns in new/modified files
          # This is a soft check - may have false positives

          FILES=$(git diff --name-only origin/main...HEAD 2>/dev/null || git ls-files)
          FILES=$(echo "$FILES" | grep -vE '(^NonPublic/|^\.git/|\.png$|\.jpg$|\.ico$)')

          if [ -z "$FILES" ]; then
            echo "No files to check"
            exit 0
          fi

          # Check for common personal identifier patterns
          # Adjust these patterns based on your needs
          PERSONAL_PATTERNS=(
            '@gmail\.com'
            '@yahoo\.com'
            '@hotmail\.com'
            'Copyright.*20[0-9]{2}.*[A-Z][a-z]+ [A-Z][a-z]+'
          )

          FOUND_ISSUES=0

          for pattern in "${PERSONAL_PATTERNS[@]}"; do
            echo "Checking pattern: $pattern"

            if echo "$FILES" | xargs grep -nE "$pattern" 2>/dev/null; then
              echo "⚠️  Found potential personal identifier: $pattern"
              FOUND_ISSUES=1
            fi
          done

          if [ $FOUND_ISSUES -eq 1 ]; then
            echo ""
            echo "========================================="
            echo "⚠️  Personal Identifier Warning"
            echo "========================================="
            echo "Found potential personal identifiers."
            echo "Review to ensure these are intentional."
            echo "(Copyright and author credits are usually OK)"
            echo ""
            # Don't fail the build - just warn
          fi

          echo "✅ Personal identifier check complete"

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "========================================="
          echo "Privacy Check Summary"
          echo "========================================="
          echo "✅ Hardcoded paths check"
          echo "✅ Over-logging check"
          echo "✅ Personal identifier check"
          echo ""
          echo "Note: Some warnings are advisory only."
          echo "Review findings and use judgment."
