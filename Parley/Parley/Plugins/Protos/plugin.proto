syntax = "proto3";

option csharp_namespace = "DialogEditor.Plugins.Proto";

package parley.plugin;

// Plugin host service (C# → Python communication)
service PluginHost {
  // Health check
  rpc Ping (PingRequest) returns (PingResponse);

  // Lifecycle events
  rpc Initialize (InitializeRequest) returns (InitializeResponse);
  rpc Shutdown (ShutdownRequest) returns (ShutdownResponse);
}

// Plugin service (Python → C# communication)
service Plugin {
  // Health check
  rpc Ping (PingRequest) returns (PingResponse);

  // Lifecycle notifications
  rpc OnDialogChanged (DialogChangedEvent) returns (EventResponse);
  rpc OnNodeSelected (NodeSelectedEvent) returns (EventResponse);
}

// Audio service (Plugin → Host)
service AudioService {
  rpc PlayAudio (PlayAudioRequest) returns (PlayAudioResponse);
  rpc StopAudio (StopAudioRequest) returns (StopAudioResponse);
}

// UI service (Plugin → Host)
service UIService {
  rpc ShowNotification (ShowNotificationRequest) returns (ShowNotificationResponse);
  rpc ShowDialog (ShowDialogRequest) returns (ShowDialogResponse);

  // Panel management (Epic 3 / #92)
  rpc RegisterPanel (RegisterPanelRequest) returns (RegisterPanelResponse);
  rpc UpdatePanelContent (UpdatePanelContentRequest) returns (UpdatePanelContentResponse);
  rpc ClosePanel (ClosePanelRequest) returns (ClosePanelResponse);
}

// Dialog service (Plugin → Host)
service DialogService {
  rpc GetCurrentDialog (GetCurrentDialogRequest) returns (GetCurrentDialogResponse);
  rpc GetSelectedNode (GetSelectedNodeRequest) returns (GetSelectedNodeResponse);
  rpc GetDialogStructure (GetDialogStructureRequest) returns (GetDialogStructureResponse);
}

// File service (Plugin → Host)
service FileService {
  rpc OpenFileDialog (OpenFileDialogRequest) returns (OpenFileDialogResponse);
  rpc SaveFileDialog (SaveFileDialogRequest) returns (SaveFileDialogResponse);
  rpc ReadFile (ReadFileRequest) returns (ReadFileResponse);
  rpc WriteFile (WriteFileRequest) returns (WriteFileResponse);
}

// Messages
message PingRequest {
  int64 timestamp = 1;
}

message PingResponse {
  int64 timestamp = 1;
  string status = 2;
}

message InitializeRequest {
  string plugin_id = 1;
  string parley_version = 2;
  map<string, string> config = 3;
}

message InitializeResponse {
  bool success = 1;
  string error_message = 2;
}

message ShutdownRequest {
  string reason = 1;
}

message ShutdownResponse {
  bool success = 1;
}

message DialogChangedEvent {
  string dialog_id = 1;
  string change_type = 2;
}

message NodeSelectedEvent {
  string node_id = 1;
}

message EventResponse {
  bool handled = 1;
}

// Audio service messages
message PlayAudioRequest {
  string file_path = 1;
}

message PlayAudioResponse {
  bool success = 1;
  string error_message = 2;
}

message StopAudioRequest {
}

message StopAudioResponse {
  bool success = 1;
}

// UI service messages
message ShowNotificationRequest {
  string message = 1;
  string title = 2;
}

message ShowNotificationResponse {
  bool success = 1;
}

message ShowDialogRequest {
  string message = 1;
  string title = 2;
  repeated string buttons = 3;
}

message ShowDialogResponse {
  int32 button_index = 1;
}

// Dialog service messages
message GetCurrentDialogRequest {
}

message GetCurrentDialogResponse {
  string dialog_id = 1;
  string dialog_name = 2;
}

message GetSelectedNodeRequest {
}

message GetSelectedNodeResponse {
  string node_id = 1;
  string node_text = 2;
}

// File service messages
message OpenFileDialogRequest {
  string title = 1;
  string filter = 2;
}

message OpenFileDialogResponse {
  string file_path = 1;
  bool cancelled = 2;
}

message SaveFileDialogRequest {
  string title = 1;
  string filter = 2;
  string default_name = 3;
}

message SaveFileDialogResponse {
  string file_path = 1;
  bool cancelled = 2;
}

message ReadFileRequest {
  string file_path = 1;
}

message ReadFileResponse {
  bytes content = 1;
  bool success = 2;
  string error_message = 3;
}

message WriteFileRequest {
  string file_path = 1;
  bytes content = 2;
}

message WriteFileResponse {
  bool success = 1;
  string error_message = 2;
}

// Panel management messages (Epic 3 / #92)
message RegisterPanelRequest {
  string panel_id = 1;           // Unique identifier for this panel
  string title = 2;              // Display title
  string position = 3;           // "left", "right", "bottom", or "float"
  string render_mode = 4;        // "webview" or "native" (webview recommended)
  int32 initial_width = 5;       // Initial width in pixels (0 = auto)
  int32 initial_height = 6;      // Initial height in pixels (0 = auto)
  bool can_float = 7;            // Whether panel can be undocked to floating
  bool can_close = 8;            // Whether user can close the panel
}

message RegisterPanelResponse {
  bool success = 1;
  string error_message = 2;
  string actual_panel_id = 3;    // The ID assigned (may differ if collision)
}

message UpdatePanelContentRequest {
  string panel_id = 1;
  string content_type = 2;       // "html", "url", or "json"
  string content = 3;            // HTML string, URL, or JSON descriptor
}

message UpdatePanelContentResponse {
  bool success = 1;
  string error_message = 2;
}

message ClosePanelRequest {
  string panel_id = 1;
}

message ClosePanelResponse {
  bool success = 1;
}

// Dialog structure messages (Epic 3 / #227)
message GetDialogStructureRequest {
}

message GetDialogStructureResponse {
  bool success = 1;
  string error_message = 2;
  string dialog_id = 3;
  string dialog_name = 4;
  repeated DialogNodeProto nodes = 5;
  repeated DialogLinkProto links = 6;
}

message DialogNodeProto {
  string id = 1;              // Unique node ID (e.g., "entry_0", "reply_3")
  string type = 2;            // "npc", "pc", "root", or "link"
  string text = 3;            // Node text (first language found)
  string speaker = 4;         // Speaker tag (for NPC entries)
  bool is_link = 5;           // Whether this is a link to another node
  string link_target = 6;     // Target node ID if is_link is true
  bool has_condition = 7;     // Has conditional script (ScriptAppears)
  bool has_action = 8;        // Has action script (ScriptAction)
  string condition_script = 9; // Condition script name (if any)
  string action_script = 10;  // Action script name (if any)
}

message DialogLinkProto {
  string source = 1;          // Source node ID
  string target = 2;          // Target node ID
  bool has_condition = 3;     // Has conditional script on this edge
  string condition_script = 4; // Condition script name (if any)
}
