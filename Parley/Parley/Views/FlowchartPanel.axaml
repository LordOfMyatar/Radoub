<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:agc="clr-namespace:AvaloniaGraphControl;assembly=AvaloniaGraphControl"
             xmlns:vm="using:DialogEditor.ViewModels"
             xmlns:models="using:DialogEditor.Models"
             x:Class="DialogEditor.Views.FlowchartPanel">

    <Design.DataContext>
        <vm:FlowchartPanelViewModel/>
    </Design.DataContext>

    <!-- Style for edge/arrow colors - theme-aware -->
    <UserControl.Styles>
        <Style Selector="agc|Connection">
            <Setter Property="Brush" Value="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
        </Style>

        <!-- Focus indicator for FlowchartPanel (#812) -->
        <Style Selector="UserControl:focus-within Border#FocusBorder">
            <Setter Property="BorderBrush" Value="{DynamicResource SystemAccentColor}"/>
            <Setter Property="BorderThickness" Value="2"/>
        </Style>
        <Style Selector="UserControl:not(:focus-within) Border#FocusBorder">
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="2"/>
        </Style>
    </UserControl.Styles>

    <!-- Focus border wraps the entire control (#812) -->
    <Border x:Name="FocusBorder" CornerRadius="2">
    <Grid RowDefinitions="Auto,*,Auto">
        <!-- Toolbar with zoom controls -->
        <Border Grid.Row="0"
                Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                Padding="4"
                IsVisible="{Binding HasContent}">
            <StackPanel Orientation="Horizontal" Spacing="4">
                <Button x:Name="ZoomInButton" Content="+" Width="28" Height="28"
                        ToolTip.Tip="Zoom In (Ctrl +)" Click="OnZoomInClick"/>
                <Button x:Name="ZoomOutButton" Content="-" Width="28" Height="28"
                        ToolTip.Tip="Zoom Out (Ctrl -)" Click="OnZoomOutClick"/>
                <TextBlock x:Name="ZoomLevelText" Text="100%"
                           VerticalAlignment="Center" Margin="8,0"
                           Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
                <Button x:Name="ZoomResetButton" Content="Reset" Height="28"
                        ToolTip.Tip="Reset Zoom (Ctrl 0)" Click="OnZoomResetClick"/>
                <Button x:Name="ZoomFitButton" Content="Fit" Height="28"
                        ToolTip.Tip="Fit to Window" Click="OnZoomFitClick"/>
                <Rectangle Width="1" Height="20" Fill="{DynamicResource SystemControlForegroundBaseMediumBrush}" Margin="4,0"/>
                <Button x:Name="RefreshButton" Width="28" Height="28"
                        ToolTip.Tip="Refresh flowchart colors" Click="OnRefreshClick"
                        HorizontalContentAlignment="Center" VerticalContentAlignment="Center">
                    <TextBlock Text="↻" FontSize="14" TextAlignment="Center"/>
                </Button>
                <Rectangle Width="1" Height="20" Fill="{DynamicResource SystemControlForegroundBaseMediumBrush}" Margin="4,0"/>
                <Button x:Name="CollapseAllButton" Height="28" Padding="10,4"
                        ToolTip.Tip="Collapse all nodes"
                        Click="OnCollapseAllClick">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="▶" FontSize="12"/>
                        <TextBlock Text="Collapse All" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
                <Button x:Name="ExpandAllButton" Height="28" Padding="10,4"
                        ToolTip.Tip="Expand all nodes"
                        Click="OnExpandAllClick">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="▼" FontSize="12"/>
                        <TextBlock Text="Expand All" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </Border>

        <!-- Main content area -->
        <Grid Grid.Row="1">
            <!-- Flowchart panel when content exists -->
            <ScrollViewer x:Name="FlowchartScrollViewer"
                          HorizontalScrollBarVisibility="Auto"
                          VerticalScrollBarVisibility="Auto"
                          AllowAutoHide="False"
                          IsVisible="{Binding HasContent}">
                <!-- FitContainer: Stretch for normal scrolling, Center for fit mode -->
                <Border x:Name="FitContainer" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                    <!-- LayoutTransformControl updates scrollbar extents when zooming (unlike RenderTransform) -->
                    <LayoutTransformControl x:Name="ZoomContainer">
                        <agc:GraphPanel x:Name="FlowchartGraphPanel"
                                    Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                                    Graph="{Binding Graph}"
                                    LayoutMethod="SugiyamaScheme">

                    <!-- DataTemplate for FlowchartNode -->
                    <agc:GraphPanel.DataTemplates>
                        <DataTemplate DataType="{x:Type models:FlowchartNode}">
                            <Border CornerRadius="4"
                                    Padding="8,4"
                                    MinWidth="120"
                                    MaxWidth="200"
                                    Opacity="{Binding IsLink, Converter={x:Static models:FlowchartLinkOpacityConverter.Instance}}">
                                <!-- Context menu for FlowView parity with TreeView (#461) -->
                                <Border.ContextMenu>
                                    <ContextMenu DataContext="{Binding}">
                                        <MenuItem Header="Add Node" InputGesture="Ctrl+D" Tag="AddNode"/>
                                        <MenuItem Header="Add Sibling Node" InputGesture="Ctrl+Shift+D" Tag="AddSiblingNode"/>
                                        <MenuItem Header="Delete Node" InputGesture="Delete" Tag="DeleteNode"/>
                                        <Separator/>
                                        <MenuItem Header="Cut Node" InputGesture="Ctrl+X" Tag="CutNode"/>
                                        <MenuItem Header="Copy Node" InputGesture="Ctrl+C" Tag="CopyNode"/>
                                        <MenuItem Header="Paste" InputGesture="Ctrl+V" Tag="PasteNode"/>
                                        <MenuItem Header="Paste as Link" InputGesture="Ctrl+L" Tag="PasteAsLink"/>
                                        <Separator/>
                                        <MenuItem Header="Move Up" InputGesture="Ctrl+Shift+Up" Tag="MoveUp"/>
                                        <MenuItem Header="Move Down" InputGesture="Ctrl+Shift+Down" Tag="MoveDown"/>
                                        <Separator/>
                                        <MenuItem Header="Expand Subnodes" InputGesture="Ctrl+E" Tag="ExpandSubnodes"/>
                                        <MenuItem Header="Collapse Subnodes" InputGesture="Ctrl+W" Tag="CollapseSubnodes"/>
                                        <Separator/>
                                        <MenuItem Header="Go to Link Target" InputGesture="Ctrl+J" Tag="GoToLinkTarget"
                                                  IsVisible="{Binding IsLink}"/>
                                        <MenuItem Header="Go to Parent Node" InputGesture="Ctrl+J" Tag="GoToParent"
                                                  IsVisible="{Binding !IsLink}"/>
                                    </ContextMenu>
                                </Border.ContextMenu>
                                <Border.Background>
                                    <MultiBinding Converter="{x:Static models:FlowchartNodeBackgroundConverter.Instance}">
                                        <Binding Path="NodeType"/>
                                        <Binding Path="IsLink"/>
                                        <Binding Path="Speaker"/>
                                        <Binding Path="ActualThemeVariant" RelativeSource="{RelativeSource AncestorType=TopLevel}"/>
                                    </MultiBinding>
                                </Border.Background>
                                <Border.BorderBrush>
                                    <MultiBinding Converter="{x:Static models:FlowchartNodeBorderConverter.Instance}">
                                        <Binding Path="NodeType"/>
                                        <Binding Path="IsLink"/>
                                        <Binding Path="Speaker"/>
                                        <Binding Path="ActualThemeVariant" RelativeSource="{RelativeSource AncestorType=TopLevel}"/>
                                    </MultiBinding>
                                </Border.BorderBrush>
                                <Border.BorderThickness>
                                    <MultiBinding Converter="{x:Static models:FlowchartNodeSelectionBorderConverter.Instance}">
                                        <Binding Path="Id"/>
                                        <Binding Path="IsLink"/>
                                        <Binding Path="DataContext.SelectedNodeId" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                    </MultiBinding>
                                </Border.BorderThickness>
                                <StackPanel Spacing="2">
                                    <!-- Speaker label -->
                                    <TextBlock Text="{Binding Speaker}"
                                               FontSize="10"
                                               FontWeight="Bold"
                                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                                    <!-- Node text - uses MaxLines for truncation with ellipsis (#813) -->
                                    <TextBlock Text="{Binding DisplayText}"
                                               FontSize="11"
                                               TextWrapping="Wrap"
                                               TextTrimming="CharacterEllipsis"
                                               MaxLines="{Binding DataContext.NodeMaxLines, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                               MaxWidth="180"
                                               ToolTip.Tip="{Binding Text}"
                                               Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
                                    <!-- Indicators for conditions/actions/collapse -->
                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                        <TextBlock Text="❓" FontSize="9" Foreground="#0066CC"
                                                   IsVisible="{Binding HasCondition}"
                                                   ToolTip.Tip="Has conditional script (ScriptAppears)"/>
                                        <TextBlock Text="⚡" FontSize="9" Foreground="#FF6600"
                                                   IsVisible="{Binding HasAction}"
                                                   ToolTip.Tip="Has action script (ScriptAction)"/>
                                        <!-- Collapse indicator - shows when node has children -->
                                        <TextBlock x:Name="CollapseIndicator"
                                                   FontSize="9"
                                                   Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"
                                                   Cursor="Hand"
                                                   ToolTip.Tip="Double-click to collapse/expand children">
                                            <TextBlock.IsVisible>
                                                <Binding Path="ChildCount" Converter="{x:Static models:FlowchartHasChildrenConverter.Instance}"/>
                                            </TextBlock.IsVisible>
                                            <TextBlock.Text>
                                                <MultiBinding Converter="{x:Static models:FlowchartCollapseTextConverter.Instance}">
                                                    <Binding Path="IsCollapsed"/>
                                                    <Binding Path="ChildCount"/>
                                                </MultiBinding>
                                            </TextBlock.Text>
                                        </TextBlock>
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </agc:GraphPanel.DataTemplates>
                        </agc:GraphPanel>
                    </LayoutTransformControl>
                </Border>
            </ScrollViewer>

            <!-- Placeholder when no content -->
            <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                    IsVisible="{Binding !HasContent}">
                <StackPanel VerticalAlignment="Center"
                            HorizontalAlignment="Center"
                            Spacing="10">
                    <TextBlock Text="Flowchart View"
                               FontSize="18"
                               FontWeight="Bold"
                               HorizontalAlignment="Center"/>
                    <TextBlock Text="Open a dialog file to view the flowchart"
                               FontSize="14"
                               HorizontalAlignment="Center"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                </StackPanel>
            </Border>
        </Grid>

        <!-- Status bar -->
        <Border Grid.Row="2"
                Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                Padding="8,4">
            <TextBlock Text="{Binding StatusText}"
                       FontSize="11"
                       VerticalAlignment="Center"/>
        </Border>
    </Grid>
    </Border>
</UserControl>
