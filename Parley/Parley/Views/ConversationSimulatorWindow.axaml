<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        x:Class="DialogEditor.Views.ConversationSimulatorWindow"
        xmlns:controls="clr-namespace:DialogEditor.Controls"
        Title="Conversation Simulator"
        MinWidth="500" MinHeight="400"
        Width="600" Height="500"
        SizeToContent="Manual"
        WindowStartupLocation="CenterOwner">

    <Window.Styles>
        <!-- Radio button selection styling -->
        <Style Selector="RadioButton:checked">
            <Setter Property="Foreground" Value="{DynamicResource SystemAccentColor}"/>
        </Style>
    </Window.Styles>

    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- Warnings -->
            <RowDefinition Height="*"/>      <!-- NPC Text -->
            <RowDefinition Height="Auto"/>  <!-- Script Info -->
            <RowDefinition Height="Auto"/>  <!-- Reply Label -->
            <RowDefinition Height="*"/>      <!-- Replies -->
            <RowDefinition Height="Auto"/>  <!-- Controls -->
            <RowDefinition Height="Auto"/>  <!-- TTS Panel -->
            <RowDefinition Height="Auto"/>  <!-- Coverage -->
        </Grid.RowDefinitions>

        <!-- Warnings Panel (Issue #484: Toggleable via ShowWarnings setting) -->
        <StackPanel Grid.Row="0" Spacing="5" Margin="0,0,0,10"
                    IsVisible="{Binding ShowWarnings}">
            <Border Background="#553D0000"
                    BorderBrush="#883D0000"
                    BorderThickness="1"
                    CornerRadius="4"
                    Padding="10,5"
                    IsVisible="{Binding ShowNoConditionalsWarning}">
                <TextBlock Text="No conditional scripts found in this dialog"
                           Foreground="#FFFFAA00"/>
            </Border>
            <Border Background="#553D0000"
                    BorderBrush="#883D0000"
                    BorderThickness="1"
                    CornerRadius="4"
                    Padding="10,5"
                    IsVisible="{Binding ShowUnreachableSiblingsWarning}">
                <TextBlock Text="NPC entries without conditions detected (unreachable siblings)"
                           Foreground="#FFFFAA00"/>
            </Border>
            <Border Background="#55550000"
                    BorderBrush="#88550000"
                    BorderThickness="1"
                    CornerRadius="4"
                    Padding="10,5"
                    IsVisible="{Binding ShowLoopWarning}">
                <TextBlock Text="Loop detected! Use Exit to escape."
                           Foreground="#FFFF6666"/>
            </Border>
        </StackPanel>

        <!-- NPC Text Display -->
        <Border Grid.Row="1"
                Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                BorderThickness="1"
                CornerRadius="4"
                Padding="15"
                Margin="0,0,0,10">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Speaker -->
                <TextBlock Grid.Row="0"
                           x:Name="SpeakerLabel"
                           Text="{Binding NpcSpeaker, StringFormat='[{0}]'}"
                           FontWeight="Bold"
                           FontSize="14"
                           Margin="0,0,0,8"
                           Foreground="{DynamicResource SystemAccentColor}"/>

                <!-- Text -->
                <ScrollViewer Grid.Row="1"
                              VerticalScrollBarVisibility="Auto">
                    <controls:TokenTextBlock x:Name="NpcTextBlock"
                               TokenText="{Binding NpcText}"
                               TextWrapping="Wrap"
                               FontSize="14"
                               LineHeight="20"/>
                </ScrollViewer>
            </Grid>
        </Border>

        <!-- Script Info Panel -->
        <Border Grid.Row="2"
                Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
                BorderThickness="1"
                CornerRadius="4"
                Padding="10,5"
                Margin="0,0,0,10"
                IsVisible="{Binding ActionScript, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
            <StackPanel Orientation="Horizontal" Spacing="20">
                <StackPanel Orientation="Horizontal" Spacing="5"
                            IsVisible="{Binding ConditionScript, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                    <TextBlock Text="Condition:"
                               FontSize="11"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"/>
                    <TextBlock Text="{Binding ConditionScript}"
                               FontSize="11"
                               FontFamily="Consolas,Courier New,monospace"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="5"
                            IsVisible="{Binding ActionScript, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                    <TextBlock Text="Action:"
                               FontSize="11"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"/>
                    <TextBlock Text="{Binding ActionScript}"
                               FontSize="11"
                               FontFamily="Consolas,Courier New,monospace"/>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- Reply Label with PC indicator -->
        <StackPanel Grid.Row="3"
                    Orientation="Horizontal"
                    Margin="0,0,0,5"
                    IsVisible="{Binding HasReplies}">
            <!-- PC Circle Symbol (color set in code-behind from SpeakerVisualHelper) -->
            <Ellipse x:Name="PcCircle"
                     Width="14" Height="14"
                     StrokeThickness="1"
                     Margin="0,0,8,0"
                     VerticalAlignment="Center"/>
            <TextBlock x:Name="ChooseResponseLabel"
                       Text="Choose response:"
                       FontWeight="SemiBold"
                       VerticalAlignment="Center"/>
        </StackPanel>

        <!-- Replies List -->
        <Border Grid.Row="4"
                Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                BorderThickness="1"
                CornerRadius="4"
                Padding="10"
                Margin="0,0,0,15"
                IsVisible="{Binding HasReplies}">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <ItemsControl x:Name="RepliesItemsControl"
                              ItemsSource="{Binding Replies}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <!-- Issue #484: Warning icon for unreachable entries (respects ShowWarnings setting) -->
                                <TextBlock Text="⚠"
                                           ToolTip.Tip="Unreachable: A prior sibling NPC entry has no condition script"
                                           VerticalAlignment="Center"
                                           Margin="0,0,5,0">
                                    <TextBlock.IsVisible>
                                        <MultiBinding Converter="{x:Static BoolConverters.And}">
                                            <Binding Path="IsUnreachable"/>
                                            <Binding Path="$parent[Window].DataContext.ShowWarnings"/>
                                        </MultiBinding>
                                    </TextBlock.IsVisible>
                                </TextBlock>
                                <RadioButton GroupName="Replies"
                                             Content="{Binding DisplayText}"
                                             Tag="{Binding Index}"
                                             Margin="0,3"
                                             Click="OnReplyClicked"/>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Border>

        <!-- Conversation Ended Message -->
        <Border Grid.Row="4"
                Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
                BorderThickness="1"
                CornerRadius="4"
                Padding="20"
                Margin="0,0,0,15"
                IsVisible="{Binding HasEnded}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <TextBlock Text="Conversation Ended"
                           FontSize="16"
                           FontWeight="Bold"
                           HorizontalAlignment="Center"
                           Margin="0,0,0,10"/>
                <TextBlock Text="{Binding StatusMessage}"
                           FontSize="12"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                           HorizontalAlignment="Center"/>
            </StackPanel>
        </Border>

        <!-- Control Buttons -->
        <StackPanel Grid.Row="5"
                    Orientation="Horizontal"
                    HorizontalAlignment="Center"
                    Spacing="10"
                    Margin="0,0,0,15">
            <Button x:Name="SpeakButton"
                    Content="Speak"
                    Width="80"
                    Click="OnSpeakClick"
                    IsEnabled="{Binding TtsAvailable}"
                    ToolTip.Tip="Speak current NPC text"/>
            <Button x:Name="StopButton"
                    Content="Stop"
                    Width="80"
                    Click="OnStopClick"
                    IsEnabled="{Binding TtsSpeaking}"
                    ToolTip.Tip="Stop speaking"/>
            <Button x:Name="SkipButton"
                    Content="Skip"
                    Width="80"
                    Click="OnSkipClick"
                    ToolTip.Tip="Auto-advance if single reply"/>
            <Button x:Name="RestartButton"
                    Content="Restart"
                    Width="80"
                    Click="OnRestartClick"
                    ToolTip.Tip="Start conversation from beginning"/>
            <Button x:Name="ExitButton"
                    Content="Exit"
                    Width="80"
                    Click="OnExitClick"
                    ToolTip.Tip="Exit simulator"/>
        </StackPanel>

        <!-- TTS Panel (Issue #479) -->
        <Expander Grid.Row="6"
                  x:Name="TtsExpander"
                  Header="Text-to-Speech Settings"
                  Margin="0,0,0,10"
                  IsExpanded="False"
                  IsVisible="{Binding TtsAvailable}">
            <Border Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                    BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
                    BorderThickness="1"
                    CornerRadius="4"
                    Padding="10">
                <!-- TTS Settings -->
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Enable checkbox, auto-speak, auto-advance, and speed -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="15" Margin="0,0,0,10">
                        <CheckBox Content="Enable TTS"
                                  IsChecked="{Binding TtsEnabled}"
                                  ToolTip.Tip="Enable text-to-speech"/>
                        <CheckBox Content="Auto-Speak"
                                  IsChecked="{Binding AutoSpeak}"
                                  ToolTip.Tip="Automatically speak each line"/>
                        <CheckBox Content="Auto-Advance"
                                  IsChecked="{Binding AutoAdvance}"
                                  ToolTip.Tip="Auto-advance when only one reply option (waits for TTS when Auto-Speak is on)"/>
                        <StackPanel Orientation="Horizontal" Spacing="5">
                            <TextBlock Text="Speed:"
                                       VerticalAlignment="Center"/>
                            <Slider x:Name="TtsRateSlider"
                                    Width="100"
                                    Minimum="0.5"
                                    Maximum="2.0"
                                    Value="{Binding TtsRate}"
                                    TickFrequency="0.1"
                                    IsSnapToTickEnabled="True"
                                    VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding TtsRate, StringFormat={}{0:F1}x}"
                                       Width="35"
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                    </StackPanel>

                    <!-- Voice Assignments -->
                    <TextBlock Grid.Row="1"
                               Text="Voice Assignments:"
                               FontWeight="SemiBold"
                               Margin="0,0,0,5"/>
                    <ItemsControl Grid.Row="2"
                                  ItemsSource="{Binding SpeakerVoiceAssignments}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="120"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0"
                                               Text="{Binding SpeakerName}"
                                               VerticalAlignment="Center"/>
                                    <ComboBox Grid.Column="1"
                                              ItemsSource="{Binding $parent[Window].DataContext.VoiceNames}"
                                              SelectedItem="{Binding VoiceName}"
                                              MinWidth="150"/>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Grid>
            </Border>
        </Expander>

        <!-- TTS Unavailable Warning (in same row, mutually exclusive) -->
        <Border Grid.Row="6"
                Background="#553D0000"
                BorderBrush="#883D0000"
                BorderThickness="1"
                CornerRadius="4"
                Padding="10"
                Margin="0,0,0,10"
                IsVisible="{Binding !TtsAvailable}">
            <StackPanel Spacing="5">
                <TextBlock Text="Text-to-Speech not available"
                           FontWeight="SemiBold"
                           Foreground="#FFFFAA00"/>
                <TextBlock Text="{Binding TtsUnavailableReason}"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                           TextWrapping="Wrap"/>
                <TextBlock Text="{Binding TtsInstallInstructions}"
                           FontSize="11"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                           TextWrapping="Wrap"/>
            </StackPanel>
        </Border>

        <!-- Coverage Display -->
        <Border Grid.Row="7"
                Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
                BorderThickness="1"
                CornerRadius="4"
                Padding="10,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0"
                           Text="Coverage:"
                           FontWeight="SemiBold"
                           VerticalAlignment="Center"
                           Margin="0,0,10,0"/>

                <TextBlock Grid.Column="1"
                           x:Name="CoverageLabel"
                           Text="{Binding CoverageDisplay}"
                           VerticalAlignment="Center"/>

                <!-- Issue #484: Toggle warnings visibility -->
                <CheckBox Grid.Column="2"
                          Content="⚠ Warnings"
                          IsChecked="{Binding ShowWarnings}"
                          VerticalAlignment="Center"
                          Margin="0,0,10,0"
                          ToolTip.Tip="Show/hide unreachable sibling warnings"/>

                <Button Grid.Column="3"
                        x:Name="ClearCoverageButton"
                        Content="Clear"
                        Padding="15,5"
                        Click="OnClearCoverageClick"
                        ToolTip.Tip="Reset coverage tracking for this dialog"/>
            </Grid>
        </Border>
    </Grid>
</Window>
