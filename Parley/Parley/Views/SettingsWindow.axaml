<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="600" d:DesignHeight="500"
        x:Class="DialogEditor.Views.SettingsWindow"
        Title="Settings - Parley"
        Width="600" Height="500"
        WindowStartupLocation="CenterOwner"
        CanResize="True">

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <TextBlock Grid.Row="0" Text="Settings" FontSize="18" FontWeight="Bold" Margin="0,0,0,10"/>

        <!-- Settings Content -->
        <TabControl x:Name="SettingsTabControl" Grid.Row="1">
            <!-- Resource Paths Tab -->
            <TabItem Header="Resource Paths">
                <ScrollViewer>
                    <StackPanel Margin="10" Spacing="15">
                        <!-- Base Game Installation Path -->
                        <Border BorderBrush="Gray" BorderThickness="1" Padding="10" CornerRadius="5">
                            <StackPanel Spacing="8">
                                <TextBlock Text="Base Game Installation Path (Optional)" FontWeight="Bold"/>
                                <TextBlock Text="Path to Neverwinter Nights game installation (e.g., Steam: steamapps\common\Neverwinter Nights - contains data\ folder with base game resources)"
                                          TextWrapping="Wrap" FontSize="11" Foreground="Gray"/>

                                <Grid ColumnDefinitions="*,Auto,Auto">
                                    <TextBox x:Name="BaseGamePathTextBox" Grid.Column="0"
                                            Watermark="C:\Program Files (x86)\Steam\steamapps\common\Neverwinter Nights"/>
                                    <Button Grid.Column="1" Content="Browse..." Click="OnBrowseBaseGamePathClick"
                                           Margin="5,0,0,0" Padding="10,5"/>
                                    <Button Grid.Column="2" Content="Auto-Detect" Click="OnAutoDetectBaseGamePathClick"
                                           Margin="5,0,0,0" Padding="10,5"/>
                                </Grid>

                                <TextBlock x:Name="BaseGamePathValidation" Foreground="Green" FontSize="11"/>
                            </StackPanel>
                        </Border>

                        <!-- User Data Directory Path -->
                        <Border BorderBrush="Gray" BorderThickness="1" Padding="10" CornerRadius="5">
                            <StackPanel Spacing="8">
                                <TextBlock Text="User Data Directory Path" FontWeight="Bold"/>
                                <TextBlock Text="Path to user data directory (Documents\Neverwinter Nights - contains modules, custom sounds, etc.)"
                                          TextWrapping="Wrap" FontSize="11" Foreground="Gray"/>

                                <Grid ColumnDefinitions="*,Auto,Auto">
                                    <TextBox x:Name="GamePathTextBox" Grid.Column="0"
                                            Watermark="C:\Users\[user]\Documents\Neverwinter Nights"/>
                                    <Button Grid.Column="1" Content="Browse..." Click="OnBrowseGamePathClick"
                                           Margin="5,0,0,0" Padding="10,5"/>
                                    <Button Grid.Column="2" Content="Auto-Detect" Click="OnAutoDetectGamePathClick"
                                           Margin="5,0,0,0" Padding="10,5"/>
                                </Grid>

                                <TextBlock x:Name="GamePathValidation" Foreground="Green" FontSize="11"/>
                            </StackPanel>
                        </Border>

                        <!-- Module Directory Path - DISABLED (using .dlg file location) -->
                        <!--
                        <Border BorderBrush="Gray" BorderThickness="1" Padding="10" CornerRadius="5">
                            <StackPanel Spacing="8">
                                <TextBlock Text="Module Directory Path" FontWeight="Bold"/>
                                <TextBlock Text="Path to module directory (contains .mod files or extracted module folders)"
                                          TextWrapping="Wrap" FontSize="11" Foreground="Gray"/>

                                <Grid ColumnDefinitions="*,Auto,Auto">
                                    <TextBox x:Name="ModulePathTextBox" Grid.Column="0"
                                            Watermark="C:\Users\[user]\Documents\Neverwinter Nights\modules"/>
                                    <Button Grid.Column="1" Content="Browse..." Click="OnBrowseModulePathClick"
                                           Margin="5,0,0,0" Padding="10,5"/>
                                    <Button Grid.Column="2" Content="Auto-Detect" Click="OnAutoDetectModulePathClick"
                                           Margin="5,0,0,0" Padding="10,5"/>
                                </Grid>

                                <TextBlock x:Name="ModulePathValidation" Foreground="Green" FontSize="11"/>
                            </StackPanel>
                        </Border>

                        <Border BorderBrush="Gray" BorderThickness="1" Padding="10" CornerRadius="5">
                            <StackPanel Spacing="8">
                                <TextBlock Text="Recent Modules" FontWeight="Bold"/>
                                <TextBlock Text="Quickly switch between recently used module directories"
                                          TextWrapping="Wrap" FontSize="11" Foreground="Gray"/>

                                <ListBox x:Name="RecentModulesListBox" Height="100"
                                        SelectionChanged="OnRecentModuleSelected"/>

                                <Button Content="Clear Recent Modules" Click="OnClearRecentModulesClick"
                                       HorizontalAlignment="Left" Padding="10,5"/>
                            </StackPanel>
                        </Border>
                        -->

                        <!-- External Script Editor -->
                        <Border BorderBrush="Gray" BorderThickness="1" Padding="10" CornerRadius="5">
                            <StackPanel Spacing="8">
                                <TextBlock Text="External Script Editor (Optional)" FontWeight="Bold"/>
                                <TextBlock Text="Path to external text editor for viewing .nss scripts (VS Code, Notepad++, etc.). Leave empty to use system default."
                                          TextWrapping="Wrap" FontSize="11" Foreground="Gray"/>
                                <Grid ColumnDefinitions="*,Auto">
                                    <TextBox x:Name="ExternalEditorPathTextBox" Grid.Column="0"
                                            Watermark="C:\Program Files\Microsoft VS Code\Code.exe"/>
                                    <Button Grid.Column="1" Content="Browse..." Click="OnBrowseExternalEditorClick"
                                           Margin="5,0,0,0" Padding="10,5"/>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <!-- Path Information -->
                        <Border BorderBrush="LightBlue" BorderThickness="1" Padding="10" CornerRadius="5"
                               Background="LightBlue" Opacity="0.2">
                            <StackPanel Spacing="5">
                                <TextBlock Text="â„¹ï¸ Platform-Specific Default Paths:" FontWeight="Bold" FontSize="12"/>
                                <TextBlock x:Name="PlatformPathsInfo" TextWrapping="Wrap" FontSize="11"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- UI Settings Tab -->
            <TabItem Header="UI Settings">
                <ScrollViewer>
                    <StackPanel Margin="10" Spacing="15">
                        <!-- Theme -->
                        <Border BorderBrush="Gray" BorderThickness="1" Padding="10" CornerRadius="5">
                            <StackPanel Spacing="8">
                                <TextBlock Text="Theme" FontWeight="Bold"/>
                                <TextBlock Text="Choose a color theme for Parley. Accessibility themes are optimized for color blindness."
                                          TextWrapping="Wrap" FontSize="11" Foreground="Gray"/>

                                <!-- Standard Themes -->
                                <TextBlock Text="Standard Themes" FontWeight="SemiBold" Margin="0,10,0,5"/>
                                <ComboBox x:Name="ThemeComboBox"
                                         SelectionChanged="OnThemeComboBoxChanged"
                                         HorizontalAlignment="Stretch"
                                         MinWidth="300"/>

                                <!-- Theme Description -->
                                <Border x:Name="ThemeDescriptionBorder"
                                       BorderBrush="LightGray" BorderThickness="1"
                                       Padding="10" Margin="0,10,0,0" CornerRadius="3"
                                       Background="{DynamicResource ThemeBackground}">
                                    <StackPanel Spacing="5">
                                        <TextBlock x:Name="ThemeNameText" FontWeight="Bold"/>
                                        <TextBlock x:Name="ThemeDescriptionText" TextWrapping="Wrap" FontSize="11"/>
                                        <TextBlock x:Name="ThemeAccessibilityText" TextWrapping="Wrap" FontSize="11" Foreground="DarkGreen"/>
                                    </StackPanel>
                                </Border>

                                <!-- Theme Actions -->
                                <StackPanel Orientation="Horizontal" Spacing="10" Margin="0,10,0,0">
                                    <Button Content="Get Themes" Click="OnGetThemesClick" Padding="10,5"
                                           ToolTip.Tip="Browse community themes on GitHub"/>
                                    <TextBlock x:Name="EasterEggHint" Text="ðŸ’¡ Tip: Click here for hidden themes..."
                                              FontSize="10" Foreground="Gray" VerticalAlignment="Center"
                                              Opacity="0.6" Cursor="Hand"
                                              PointerPressed="OnEasterEggHintClick"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>

                        <!-- Font Settings -->
                        <Border BorderBrush="Gray" BorderThickness="1" Padding="10" CornerRadius="5">
                            <StackPanel Spacing="8">
                                <TextBlock Text="Font Settings" FontWeight="Bold"/>

                                <!-- Font Size -->
                                <TextBlock Text="Font Size" FontWeight="Normal"/>
                                <Grid ColumnDefinitions="*,Auto">
                                    <Slider x:Name="FontSizeSlider" Grid.Column="0"
                                           Minimum="8" Maximum="24" Value="14"
                                           TickFrequency="1" IsSnapToTickEnabled="True"
                                           ValueChanged="OnFontSizeChanged"/>
                                    <TextBlock x:Name="FontSizeLabel" Grid.Column="1"
                                              Text="14" Margin="10,0,0,0" VerticalAlignment="Center"/>
                                </Grid>

                                <!-- Font Family -->
                                <TextBlock Text="Font Family" FontWeight="Normal" Margin="0,10,0,0"/>
                                <ComboBox x:Name="FontFamilyComboBox"
                                         SelectionChanged="OnFontFamilyChanged"
                                         HorizontalAlignment="Stretch">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding}" FontFamily="{Binding}"/>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>

                                <!-- Font Preview -->
                                <Border BorderBrush="LightGray" BorderThickness="1" Padding="10" Margin="0,10,0,0" CornerRadius="3">
                                    <TextBlock x:Name="FontPreviewText"
                                              Text="The quick brown fox jumps over the lazy dog. 1234567890"
                                              TextWrapping="Wrap"
                                              HorizontalAlignment="Center"/>
                                </Border>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Logging Tab -->
            <TabItem Header="Logging">
                <ScrollViewer>
                    <StackPanel Margin="10" Spacing="15">
                        <!-- Log Level -->
                        <Border BorderBrush="Gray" BorderThickness="1" Padding="10" CornerRadius="5">
                            <StackPanel Spacing="8">
                                <TextBlock Text="Log Level" FontWeight="Bold"/>
                                <ComboBox x:Name="LogLevelComboBox" SelectionChanged="OnLogLevelChanged"/>
                            </StackPanel>
                        </Border>

                        <!-- Log Retention -->
                        <Border BorderBrush="Gray" BorderThickness="1" Padding="10" CornerRadius="5">
                            <StackPanel Spacing="8">
                                <TextBlock Text="Log Retention" FontWeight="Bold"/>
                                <TextBlock Text="Number of recent sessions to keep (default: 3)"
                                          FontSize="11" Foreground="Gray"/>
                                <Grid ColumnDefinitions="*,Auto">
                                    <Slider x:Name="LogRetentionSlider" Grid.Column="0"
                                           Minimum="1" Maximum="10" Value="3"
                                           TickFrequency="1" IsSnapToTickEnabled="True"
                                           ValueChanged="OnLogRetentionChanged"/>
                                    <TextBlock x:Name="LogRetentionLabel" Grid.Column="1"
                                              Text="3 sessions" Margin="10,0,0,0" VerticalAlignment="Center"/>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <!-- Debug Panel Visibility -->
                        <Border BorderBrush="Gray" BorderThickness="1" Padding="10" CornerRadius="5">
                            <StackPanel Spacing="8">
                                <TextBlock Text="Debug Panel" FontWeight="Bold"/>
                                <CheckBox x:Name="ShowDebugPanelCheckBox"
                                         Content="Show debug console panel"
                                         Checked="OnShowDebugPanelChanged"
                                         Unchecked="OnShowDebugPanelChanged"/>
                                <TextBlock Text="Display the debug console tab in the main window"
                                          FontSize="11" Foreground="Gray" Margin="25,0,0,0"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Auto-Save Tab (Issue #62) -->
            <TabItem Header="Auto-Save">
                <ScrollViewer>
                    <StackPanel Margin="10" Spacing="15">
                        <!-- Enable Auto-Save -->
                        <Border BorderBrush="Gray" BorderThickness="1" Padding="10" CornerRadius="5">
                            <StackPanel Spacing="8">
                                <CheckBox x:Name="AutoSaveEnabledCheckBox"
                                         Content="Enable Auto-Save"
                                         FontWeight="Bold"
                                         Checked="OnAutoSaveEnabledChanged"
                                         Unchecked="OnAutoSaveEnabledChanged"/>
                                <TextBlock Text="Automatically save dialog file after changes"
                                          TextWrapping="Wrap" FontSize="11" Foreground="Gray"/>
                            </StackPanel>
                        </Border>

                        <!-- Auto-Save Interval -->
                        <Border BorderBrush="Gray" BorderThickness="1" Padding="10" CornerRadius="5">
                            <StackPanel Spacing="8">
                                <TextBlock Text="Auto-Save Interval" FontWeight="Bold"/>
                                <TextBlock Text="Set auto-save interval. 0 = fast debounce (2 seconds after last change), 1-60 = periodic save every N minutes."
                                          TextWrapping="Wrap" FontSize="11" Foreground="Gray"/>

                                <Grid ColumnDefinitions="*,Auto">
                                    <Slider x:Name="AutoSaveIntervalSlider" Grid.Column="0"
                                           Minimum="0" Maximum="60" Value="0"
                                           TickFrequency="5" IsSnapToTickEnabled="True"
                                           ValueChanged="OnAutoSaveIntervalChanged"/>
                                    <TextBlock x:Name="AutoSaveIntervalLabel" Grid.Column="1"
                                              Text="Fast debounce (2s)" Margin="10,0,0,0" VerticalAlignment="Center" MinWidth="150"/>
                                </Grid>

                                <Border BorderBrush="LightBlue" BorderThickness="1" Padding="8" CornerRadius="3"
                                       Background="LightBlue" Opacity="0.2">
                                    <StackPanel Spacing="5">
                                        <TextBlock Text="â„¹ï¸ Fast Debounce Mode (0):" FontWeight="SemiBold" FontSize="11"/>
                                        <TextBlock Text="Saves 2 seconds after you stop typing. Best for real-time work."
                                                  TextWrapping="Wrap" FontSize="10"/>
                                        <TextBlock Text="â±ï¸ Periodic Mode (1-60 min):" FontWeight="SemiBold" FontSize="11" Margin="0,5,0,0"/>
                                        <TextBlock Text="Saves at fixed intervals regardless of activity. Good for long editing sessions."
                                                  TextWrapping="Wrap" FontSize="10"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Parameters Tab -->
            <TabItem Header="Parameters">
                <ScrollViewer>
                    <StackPanel Margin="10" Spacing="15">
                        <!-- Enable Parameter Cache -->
                        <Border BorderBrush="Gray" BorderThickness="1" Padding="10" CornerRadius="5">
                            <StackPanel Spacing="8">
                                <CheckBox x:Name="EnableParameterCacheCheckBox"
                                         Content="Enable Parameter Value Caching"
                                         FontWeight="Bold"
                                         Checked="OnParameterCacheSettingChanged"
                                         Unchecked="OnParameterCacheSettingChanged"/>
                                <TextBlock Text="Cache recently used parameter values for faster entry. Values are stored per script and sorted by most recently used."
                                          TextWrapping="Wrap" FontSize="11" Foreground="Gray"/>
                            </StackPanel>
                        </Border>

                        <!-- Max Values Per Parameter -->
                        <Border BorderBrush="Gray" BorderThickness="1" Padding="10" CornerRadius="5">
                            <StackPanel Spacing="8">
                                <TextBlock Text="Max Cached Values Per Parameter" FontWeight="Bold"/>
                                <TextBlock Text="Maximum number of values to cache for each parameter (range: 5-50, default: 10)"
                                          FontSize="11" Foreground="Gray"/>
                                <Grid ColumnDefinitions="*,Auto">
                                    <Slider x:Name="MaxCachedValuesSlider" Grid.Column="0"
                                           Minimum="5" Maximum="50" Value="10"
                                           TickFrequency="5" IsSnapToTickEnabled="True"
                                           ValueChanged="OnMaxCachedValuesChanged"/>
                                    <TextBlock x:Name="MaxCachedValuesLabel" Grid.Column="1"
                                              Text="10 values" Margin="10,0,0,0" VerticalAlignment="Center"/>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <!-- Max Cached Scripts -->
                        <Border BorderBrush="Gray" BorderThickness="1" Padding="10" CornerRadius="5">
                            <StackPanel Spacing="8">
                                <TextBlock Text="Max Cached Scripts" FontWeight="Bold"/>
                                <TextBlock Text="Maximum number of scripts to cache parameters for (range: 100-10000, default: 1000)"
                                          FontSize="11" Foreground="Gray"/>
                                <Grid ColumnDefinitions="*,Auto">
                                    <Slider x:Name="MaxCachedScriptsSlider" Grid.Column="0"
                                           Minimum="100" Maximum="10000" Value="1000"
                                           TickFrequency="100" IsSnapToTickEnabled="True"
                                           ValueChanged="OnMaxCachedScriptsChanged"/>
                                    <TextBlock x:Name="MaxCachedScriptsLabel" Grid.Column="1"
                                              Text="1000 scripts" Margin="10,0,0,0" VerticalAlignment="Center"/>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <!-- Cache Statistics -->
                        <Border BorderBrush="LightBlue" BorderThickness="1" Padding="10" CornerRadius="5"
                               Background="LightBlue" Opacity="0.2">
                            <StackPanel Spacing="8">
                                <TextBlock Text="Cache Statistics" FontWeight="Bold"/>
                                <TextBlock x:Name="CacheStatsText" TextWrapping="Wrap" FontSize="11"/>
                                <StackPanel Orientation="Horizontal" Spacing="10" Margin="0,5,0,0">
                                    <Button Content="Clear Cache" Click="OnClearParameterCacheClick" Padding="10,5"/>
                                    <Button Content="Refresh Stats" Click="OnRefreshCacheStatsClick" Padding="10,5"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Plugins Tab -->
            <TabItem Header="Plugins">
                <ScrollViewer>
                    <StackPanel Margin="10" Spacing="15">
                        <!-- Plugin List -->
                        <Border BorderBrush="Gray" BorderThickness="1" Padding="10" CornerRadius="5">
                            <StackPanel Spacing="8">
                                <TextBlock Text="Installed Plugins" FontWeight="Bold"/>
                                <TextBlock Text="Enable or disable plugins. Changes apply on next restart."
                                          TextWrapping="Wrap" FontSize="11" Foreground="Gray"/>

                                <ListBox x:Name="PluginsListBox" MinHeight="200" MaxHeight="400"/>
                            </StackPanel>
                        </Border>

                        <!-- Safe Mode -->
                        <Border BorderBrush="Orange" BorderThickness="1" Padding="10" CornerRadius="5"
                               Background="Orange" Opacity="0.2">
                            <StackPanel Spacing="8">
                                <CheckBox x:Name="SafeModeCheckBox" Content="Disable all plugins on next launch (Safe Mode)"
                                         FontWeight="Bold" Checked="OnSafeModeChanged" Unchecked="OnSafeModeChanged"/>
                                <TextBlock Text="Use this if a plugin is causing issues. All plugins will be disabled on the next startup."
                                          TextWrapping="Wrap" FontSize="11" Foreground="Gray"/>
                            </StackPanel>
                        </Border>

                        <!-- Actions -->
                        <StackPanel Orientation="Horizontal" Spacing="10">
                            <Button Content="Open Plugins Folder" Click="OnOpenPluginsFolderClick" Padding="10,5"/>
                            <Button Content="Refresh Plugin List" Click="OnRefreshPluginsClick" Padding="10,5"/>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
        </TabControl>

        <!-- Action Buttons -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="10" Margin="0,10,0,0">
            <Button Content="OK" Click="OnOkClick" Width="80" Padding="10,5"/>
            <Button Content="Cancel" Click="OnCancelClick" Width="80" Padding="10,5"/>
        </StackPanel>
    </Grid>
</Window>
