<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:DialogEditor.ViewModels"
        xmlns:views="using:DialogEditor.Views"
        xmlns:models="using:DialogEditor.Models"
        xmlns:services="using:DialogEditor.Services"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
        x:Class="DialogEditor.Views.MainWindow"
        Title="{Binding WindowTitle}"
        Icon="avares://Parley/Assets/parley.ico"
        Width="{Binding Source={x:Static services:SettingsService.Instance}, Path=WindowWidth, Mode=TwoWay}"
        Height="{Binding Source={x:Static services:SettingsService.Instance}, Path=WindowHeight, Mode=TwoWay}"
        MinWidth="800" MinHeight="600">

    <Design.DataContext>
        <vm:MainViewModel/>
    </Design.DataContext>

    <Window.Resources>
        <!-- Converter for End flag: true = 0.5 opacity (faded), false = 1.0 opacity (normal) -->
        <models:BoolToOpacityConverter x:Key="BoolToOpacityConverter"/>
    </Window.Resources>

    <Grid x:Name="MainGrid">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="1*" MinHeight="200"/>
            <RowDefinition Height="5"/>
            <RowDefinition Height="3*" MinHeight="200"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto" MinHeight="0"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Menu Bar -->
        <Menu Grid.Row="0">
            <MenuItem Header="_File">
                <MenuItem Header="_New" InputGesture="Ctrl+N" Click="OnNewClick"/>
                <Separator/>
                <MenuItem Header="_Open..." InputGesture="Ctrl+O" Click="OnOpenClick"/>
                <MenuItem Name="RecentFilesMenuItem" Header="Recent _Files"/>
                <Separator/>
                <MenuItem Header="_Save" InputGesture="Ctrl+S" Click="OnSaveClick"/>
                <MenuItem Header="Save _As..." Click="OnSaveAsClick"/>
                <Separator/>
                <MenuItem Header="_Close" Click="OnCloseClick"/>
                <Separator/>
                <MenuItem Header="E_xit" Click="OnExitClick"/>
            </MenuItem>
            <MenuItem Header="_Edit">
                <MenuItem Header="_Undo" InputGesture="Ctrl+Z" Click="OnUndoClick"/>
                <MenuItem Header="_Redo" InputGesture="Ctrl+Y" Click="OnRedoClick"/>
                <Separator/>
                <MenuItem Header="Add _Node" InputGesture="Ctrl+D" Click="OnAddSmartNodeClick"/>
                <Separator/>
                <MenuItem Header="Move _Up" InputGesture="Ctrl+Shift+Up" Click="OnMoveNodeUpClick"/>
                <MenuItem Header="Move _Down" InputGesture="Ctrl+Shift+Down" Click="OnMoveNodeDownClick"/>
                <Separator/>
                <MenuItem Header="_Expand This and Subnodes" InputGesture="Ctrl+E" Click="OnExpandSubnodesClick"/>
                <MenuItem Header="_Collapse This and Subnodes" InputGesture="Ctrl+W" Click="OnCollapseSubnodesClick"/>
                <Separator/>
                <MenuItem Header="_Delete Node" InputGesture="Delete" Click="OnDeleteNodeClick"/>
                <Separator/>
                <MenuItem Header="Cu_t Node" InputGesture="Ctrl+X" Click="OnCutNodeClick"/>
                <MenuItem Header="_Copy Node" InputGesture="Ctrl+C" Click="OnCopyNodeClick"/>
                <MenuItem Header="_Paste" InputGesture="Ctrl+V" Click="OnPasteAsDuplicateClick"/>
                <MenuItem Header="Paste as _Link" InputGesture="Ctrl+L" Click="OnPasteAsLinkClick"/>
                <Separator/>
                <MenuItem Header="Copy Node _Text" InputGesture="Ctrl+Shift+T" Click="OnCopyNodeTextClick"/>
                <MenuItem Header="Copy Node _Properties" InputGesture="Ctrl+Shift+P" Click="OnCopyNodePropertiesClick"/>
                <MenuItem Header="Copy Tree _Structure" InputGesture="Ctrl+Shift+S" Click="OnCopyTreeStructureClick"/>
            </MenuItem>
            <MenuItem Header="_View">
                <MenuItem Header="_Logging">
                    <MenuItem Header="_Clear Debug Output" Click="OnClearDebugClick"/>
                    <MenuItem Header="Open Log _Folder" Click="OnOpenLogFolderClick"/>
                    <MenuItem Header="_Export Logs for Support..." Click="OnExportLogsClick"/>
                </MenuItem>
                <Separator/>
                <MenuItem Header="Font Size">
                    <MenuItem Header="Small (10pt)" Click="OnFontSizeClick" Tag="10"/>
                    <MenuItem Header="Normal (12pt)" Click="OnFontSizeClick" Tag="12"/>
                    <MenuItem Header="Large (14pt)" Click="OnFontSizeClick" Tag="14"/>
                    <MenuItem Header="Extra Large (16pt)" Click="OnFontSizeClick" Tag="16"/>
                    <MenuItem Header="Reader Friendly (18pt)" Click="OnFontSizeClick" Tag="18"/>
                    <MenuItem Header="Super Reader (20pt)" Click="OnFontSizeClick" Tag="20"/>
                    <MenuItem Header="Maximum (24pt)" Click="OnFontSizeClick" Tag="24"/>
                </MenuItem>
                <Separator/>
                <MenuItem Header="_Flowchart">
                    <MenuItem Header="_Open Flowchart" Click="OnFlowchartClick" InputGesture="F5"/>
                    <Separator/>
                    <MenuItem Header="Layout">
                        <MenuItem x:Name="FlowchartLayoutFloating" Header="_Floating Window" Click="OnFlowchartLayoutClick" Tag="Floating"/>
                        <MenuItem x:Name="FlowchartLayoutSideBySide" Header="_Side by Side" Click="OnFlowchartLayoutClick" Tag="SideBySide"/>
                        <MenuItem x:Name="FlowchartLayoutTabbed" Header="_Tabbed" Click="OnFlowchartLayoutClick" Tag="Tabbed"/>
                    </MenuItem>
                    <Separator/>
                    <MenuItem Header="Export">
                        <MenuItem Header="Export as _PNG..." Click="OnExportFlowchartPngClick"/>
                        <MenuItem Header="Export as _SVG..." Click="OnExportFlowchartSvgClick"/>
                    </MenuItem>
                </MenuItem>
                <Separator/>
                <MenuItem Header="_Plugin Panels" Name="PluginPanelsMenuItem" Click="OnPluginPanelsClick"/>
            </MenuItem>
            <MenuItem Header="_Settings">
                <MenuItem Header="_Preferences..." Click="OnPreferencesClick"/>
                <Separator/>
                <MenuItem Header="_Game Directories..." Click="OnGameDirectoriesClick"/>
                <MenuItem Header="_Logging Settings..." Click="OnLogSettingsClick"/>
                <Separator/>
                <MenuItem Header="_Refresh Script Cache" Click="OnRefreshScriptCacheClick"/>
            </MenuItem>
            <MenuItem Header="_Help">
                <MenuItem Header="_Documentation" Click="OnDocumentationClick"/>
                <MenuItem Header="_Report Issue" Click="OnReportIssueClick"/>
                <Separator/>
                <MenuItem Header="_About Parley" Click="OnAboutClick"/>
            </MenuItem>
        </Menu>

        <!-- Module Info Bar -->
        <Border Grid.Row="1" BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}" BorderThickness="0,0,0,1" Padding="8,4">
            <StackPanel Orientation="Horizontal" Spacing="15">
                <TextBlock x:Name="ModuleNameTextBlock"
                           Text="No module loaded"
                           FontWeight="Bold"
                           VerticalAlignment="Center"/>
                <TextBlock Text="|"
                           Foreground="Gray"
                           VerticalAlignment="Center"/>
                <TextBlock x:Name="ModulePathTextBlock"
                           Text=""
                           Foreground="Gray"
                           VerticalAlignment="Center"/>
            </StackPanel>
        </Border>

<!-- Main Content Area (spans rows 2-4 for left/right layout) -->
        <!-- DRAGON: Grid layout only - tree data binding in TreeView below -->
        <Grid Grid.Row="2" Grid.RowSpan="3" x:Name="MainContentGrid">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="800" MinWidth="500"/>  <!-- Tree+Text area -->
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*" MinWidth="350"/>  <!-- Properties area -->
                <ColumnDefinition Width="0"/>  <!-- Flowchart splitter (hidden by default, index 3) -->
                <ColumnDefinition Width="0"/>  <!-- Embedded flowchart (hidden by default, index 4) -->
            </Grid.ColumnDefinitions>

            <Grid.RowDefinitions>
                <RowDefinition Height="400" MinHeight="200"/>
                <RowDefinition Height="5"/>
                <RowDefinition Height="*" MinHeight="150"/>
            </Grid.RowDefinitions>

            <!-- Dialog Tree / Flowchart TabControl (top left) -->
            <TabControl x:Name="LeftPaneTabControl" Grid.Row="0" Grid.Column="0" Margin="5">
                <!-- Dialog Tree Tab -->
                <TabItem Header="Dialog Tree">
                    <Border BorderBrush="Gray" BorderThickness="1" Padding="5">
                        <DockPanel>
                            <!-- Tree Control Buttons -->
                            <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="0,0,0,5">
                                <Button Name="ExpandAllButton" Content="Expand All" Click="OnExpandAllClick" Margin="0,0,5,0" Padding="8,2"/>
                                <Button Name="CollapseAllButton" Content="Collapse All" Click="OnCollapseAllClick" Margin="0,0,5,0" Padding="8,2"/>
                                <Separator Width="1" Margin="5,0"/>
                                <Button Name="AddNodeButton" Content="+ Node" Click="OnAddSmartNodeClick" Margin="0,0,5,0" Padding="8,2" ToolTip.Tip="Add Node (Ctrl+D)"/>
                                <Button Name="DeleteNodeButton" Content="Delete" Click="OnDeleteNodeClick" Padding="8,2" ToolTip.Tip="Delete Node (Delete)"/>
                            </StackPanel>

                            <!-- DRAGON: DialogTreeView binding and event handlers connect to orphan handling, cut/copy/paste logic -->
                            <!-- DRAGON: Do not modify ItemsSource binding, SelectionChanged, or context menu Click handlers -->
                            <TreeView x:Name="DialogTreeView" ItemsSource="{Binding DialogNodes}"
                                      SelectedItem="{Binding SelectedTreeNode, Mode=TwoWay}"
                                      SelectionChanged="OnDialogTreeViewSelectionChanged"
                                      DoubleTapped="OnTreeViewItemDoubleTapped"
                                      Padding="0,0,0,20">
                                <TreeView.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Header="Add Node" Click="OnAddSmartNodeClick"/>
                                        <Separator/>
                                        <MenuItem Header="Move Up" InputGesture="Alt+Up" Click="OnMoveNodeUpClick"/>
                                        <MenuItem Header="Move Down" InputGesture="Alt+Down" Click="OnMoveNodeDownClick"/>
                                        <Separator/>
                                        <MenuItem Header="Delete Node" Click="OnDeleteNodeClick"/>
                                        <Separator/>
                                        <MenuItem Header="Cut Node" Click="OnCutNodeClick"/>
                                        <MenuItem Header="Copy Node" Click="OnCopyNodeClick"/>
                                        <MenuItem Header="Paste" Click="OnPasteAsDuplicateClick"/>
                                        <MenuItem Header="Paste as Link" Click="OnPasteAsLinkClick"/>
                                        <Separator/>
                                        <MenuItem Header="Expand This Node and Subnodes" InputGesture="Ctrl+E" Click="OnExpandSubnodesClick"/>
                                        <MenuItem Header="Collapse This Node and Subnodes" InputGesture="Ctrl+W" Click="OnCollapseSubnodesClick"/>
                                        <Separator/>
                                        <MenuItem Header="Copy Node Text" Click="OnCopyNodeTextClick"/>
                                        <MenuItem Header="Copy Node Properties" Click="OnCopyNodePropertiesClick"/>
                                    </ContextMenu>
                                </TreeView.ContextMenu>
                                <TreeView.Styles>
                                    <Style Selector="TreeViewItem">
                                        <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                                    </Style>
                                    <!-- Show focus indicator when TreeView has keyboard focus -->
                                    <Style Selector="TreeViewItem:focus /template/ Border#PART_LayoutRoot">
                                        <Setter Property="BorderBrush" Value="{DynamicResource SystemAccentColor}"/>
                                        <Setter Property="BorderThickness" Value="1"/>
                                    </Style>
                                    <!-- Alternative: Use background color for focus indication -->
                                    <Style Selector="TreeViewItem:selected:focus /template/ Border#PART_LayoutRoot">
                                        <Setter Property="Background" Value="{DynamicResource SystemAccentColor}"/>
                                        <Setter Property="BorderBrush" Value="{DynamicResource SystemAccentColor}"/>
                                        <Setter Property="BorderThickness" Value="2"/>
                                    </Style>
                                </TreeView.Styles>
                                <TreeView.DataTemplates>
                                    <TreeDataTemplate DataType="models:TreeViewSafeNode" ItemsSource="{Binding Children}">
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <!-- Speaker icon shape -->
                                            <Path Data="{Binding NodeShapeGeometry}"
                                                  Fill="{Binding NodeColor}"
                                                  Width="16" Height="16"
                                                  Stretch="Uniform"
                                                  VerticalAlignment="Center"
                                                  Margin="0,2,0,0"/>
                                            <!-- Node text -->
                                            <TextBlock Text="{Binding DisplayText}"
                                                       TextWrapping="Wrap"
                                                       Foreground="{Binding NodeColor}"
                                                       VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </TreeDataTemplate>
                                </TreeView.DataTemplates>
                            </TreeView>
                        </DockPanel>
                    </Border>
                </TabItem>

                <!-- Flowchart Tab (Tabbed mode) -->
                <TabItem x:Name="FlowchartTab" Header="Flowchart" IsVisible="False">
                    <views:FlowchartPanel x:Name="TabbedFlowchartPanel"/>
                </TabItem>
            </TabControl>

            <!-- Horizontal splitter between Dialog Tree and Text Entry -->
            <GridSplitter Grid.Row="1" Grid.Column="0" Height="5" HorizontalAlignment="Stretch"
                          ResizeDirection="Rows" Background="Gray"/>

            <!-- Text Entry Panel (bottom left) -->
            <Border Grid.Row="2" Grid.Column="0" BorderBrush="Gray" BorderThickness="1" Margin="5" Padding="5">
                <DockPanel>
                    <TextBlock DockPanel.Dock="Top" Text="Node Text" FontWeight="Bold" Margin="0,0,0,5"/>

                    <!-- Speaker field at top of text panel -->
                    <!-- DRAGON: Do not modify x:Name attributes or OnFieldLostFocus handler -->
                    <Grid DockPanel.Dock="Top" Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="150"/>
                            <ColumnDefinition Width="5"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="5"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="10"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="5"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Text="Speaker:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                        <TextBox x:Name="SpeakerTextBox" Grid.Column="1" MaxLength="15"
                                 TextWrapping="NoWrap" AcceptsReturn="False"
                                 TabIndex="30"
                                 GotFocus="OnFieldGotFocus"
                                 LostFocus="OnFieldLostFocus"/>
                        <ComboBox x:Name="RecentCreatureTagsComboBox" Grid.Column="3"
                                  MinWidth="80" MaxWidth="120"
                                  TabIndex="31"
                                  PlaceholderText="Recent..."
                                  SelectionChanged="OnRecentCreatureTagSelected">
                            <!-- Populated dynamically -->
                        </ComboBox>
                        <Button x:Name="BrowseCreatureButton" Grid.Column="5" Content="Browse..."
                                TabIndex="32"
                                MinWidth="55" Padding="5,0" Click="OnBrowseCreatureClick"/>

                        <!-- NPC Speaker Visual Preferences (Issue #16, #36) -->
                        <TextBlock Grid.Column="7" Text="Shape:" VerticalAlignment="Center" Margin="0,0,3,0"/>
                        <ComboBox x:Name="SpeakerShapeComboBox" Grid.Column="8" MinWidth="90"
                                 TabIndex="33"
                                 SelectionChanged="OnSpeakerShapeChanged">
                            <!-- Populated in code-behind -->
                        </ComboBox>
                        <TextBlock Grid.Column="10" Text="Color:" VerticalAlignment="Center" Margin="0,0,3,0"/>
                        <ComboBox x:Name="SpeakerColorComboBox" Grid.Column="11" MinWidth="90"
                                 TabIndex="34"
                                 SelectionChanged="OnSpeakerColorChanged">
                            <!-- Populated in code-behind -->
                        </ComboBox>
                    </Grid>

                    <!-- DRAGON: TextTextBox binding is critical - do not modify x:Name or LostFocus handler -->
                    <!-- Tab order: Ctrl+D lands here (1), then scripts, then back to speaker row -->
                    <TextBox x:Name="TextTextBox" AcceptsReturn="True"
                            TextWrapping="Wrap"
                            TabIndex="1"
                            GotFocus="OnFieldGotFocus"
                            LostFocus="OnFieldLostFocus"
                            ScrollViewer.VerticalScrollBarVisibility="Auto"
                            ScrollViewer.HorizontalScrollBarVisibility="Auto"/>
                </DockPanel>
            </Border>

            <!-- Vertical splitter between left panels and properties -->
            <GridSplitter Grid.Row="0" Grid.RowSpan="3" Grid.Column="1" Width="5" HorizontalAlignment="Stretch"
                          ResizeDirection="Columns" Background="Gray"/>

            <!-- Tabbed Properties Panel (full height right side) -->
            <!-- DRAGON: Do not modify x:Name attributes or event handlers - only visual layout -->
            <TabControl Grid.Row="0" Grid.RowSpan="3" Grid.Column="2" Margin="5">

                <!-- Scripts & Parameters Tab -->
                <TabItem Header="Scripts">
                    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto" Padding="0,0,10,0">
                        <StackPanel Margin="5,5,15,50">

                        <!-- Conditional Scripts -->
                        <TextBlock Text="Conditional Scripts:" FontWeight="Bold" Margin="0,5,0,5"/>

                        <TextBlock Text="Script (Appears When):"/>
                        <Grid Margin="0,0,0,5" HorizontalAlignment="Left">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="180"/>
                                <ColumnDefinition Width="5"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="5"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox x:Name="ScriptAppearsTextBox" Grid.Column="0" FontFamily="Consolas" TabIndex="10"
                                     TextWrapping="Wrap" GotFocus="OnFieldGotFocus" LostFocus="OnFieldLostFocus"/>
                            <Button x:Name="EditConditionalScriptButton" Grid.Column="2" Content="Edit Script"
                                    TabIndex="11"
                                    MinWidth="55" Padding="5,0" Click="OnEditConditionalScriptClick"
                                    ToolTip.Tip="Open script in external editor"/>
                            <Button x:Name="BrowseConditionalScriptButton" Grid.Column="4" Content="Browse..."
                                    TabIndex="12"
                                    MinWidth="55" Padding="5,0" Click="OnBrowseConditionalScriptClick"/>
                        </Grid>

                        <TextBlock Text="Condition Parameters:" Margin="0,5,0,2"/>
                        <Border x:Name="ConditionsParametersGrid" MinHeight="60" MaxHeight="200" BorderBrush="Gray" BorderThickness="1" Margin="0,0,0,5">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <TextBlock Grid.Row="0" Text="Key-Value pairs for condition script"
                                           FontStyle="Italic" Margin="5,5,5,2" Opacity="0.7"/>
                                <ScrollViewer Grid.Row="1" x:Name="ConditionsParamsScrollViewer" MinHeight="40"
                                             VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                                    <StackPanel x:Name="ConditionsParametersPanel" Margin="5,5,20,5"/>
                                </ScrollViewer>
                                <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="5">
                                    <Button Content="+ Add Parameter"
                                            x:Name="AddConditionsParamButton" Click="OnAddConditionsParamClick"
                                            TabIndex="13"
                                            Margin="0,0,5,0"/>
                                    <Button Content="ðŸ’¡ Suggest"
                                            x:Name="SuggestConditionsParamButton" Click="OnSuggestConditionsParamClick"
                                            TabIndex="14"
                                            Margin="0,0,10,0"
                                            ToolTip.Tip="Show available parameter keys and values from script"/>
                                    <CheckBox x:Name="AutoTrimConditionsCheckBox"
                                              Content="Auto-Trim whitespace"
                                              IsChecked="True"
                                              IsTabStop="False"
                                              ToolTip.Tip="Automatically trim leading/trailing whitespace from keys and values"/>
                                </StackPanel>
                            </Grid>
                        </Border>

                        <TextBlock Text="Conditional Script Preview:" Margin="0,5,0,2"/>
                        <Border x:Name="ConditionalScriptPreviewGrid" MinHeight="100" MaxHeight="150" BorderBrush="Gray" BorderThickness="1" Margin="0,0,0,5">
                            <ScrollViewer x:Name="ConditionalScriptPreviewScrollViewer"
                                         VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
                                <TextBox x:Name="ConditionalScriptPreviewTextBox"
                                         FontFamily="Consolas"
                                         Background="Transparent" BorderThickness="0"
                                         IsReadOnly="True" TextWrapping="NoWrap"
                                         IsTabStop="False"
                                         Text="// Conditional script preview will appear here"
                                         Margin="5"/>
                            </ScrollViewer>
                        </Border>

                        <!-- Action Scripts -->
                        <Separator Margin="0,5"/>
                        <TextBlock Text="Action Scripts:" FontWeight="Bold" Margin="0,5,0,5"/>

                        <TextBlock Text="Script (Action):"/>
                        <Grid Margin="0,0,0,5" HorizontalAlignment="Left">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="180"/>
                                <ColumnDefinition Width="5"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="5"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox x:Name="ScriptActionTextBox" Grid.Column="0" FontFamily="Consolas" TabIndex="20"
                                     TextWrapping="Wrap" GotFocus="OnFieldGotFocus" LostFocus="OnFieldLostFocus"/>
                            <Button x:Name="EditActionScriptButton" Grid.Column="2" Content="Edit Script"
                                    TabIndex="21"
                                    MinWidth="55" Padding="5,0" Click="OnEditActionScriptClick"
                                    ToolTip.Tip="Open script in external editor"/>
                            <Button x:Name="BrowseActionScriptButton" Grid.Column="4" Content="Browse..."
                                    TabIndex="22"
                                    MinWidth="55" Padding="5,0" Click="OnBrowseActionScriptClick"/>
                        </Grid>

                        <TextBlock Text="Action Parameters:" Margin="0,5,0,2"/>
                        <Border x:Name="ActionsParametersGrid" MinHeight="60" MaxHeight="200" BorderBrush="Gray" BorderThickness="1" Margin="0,0,0,5">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <TextBlock Grid.Row="0" Text="Key-Value pairs for action script"
                                           FontStyle="Italic" Margin="5,5,5,2" Opacity="0.7"/>
                                <ScrollViewer Grid.Row="1" x:Name="ActionsParamsScrollViewer" MinHeight="40"
                                             VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                                    <StackPanel x:Name="ActionsParametersPanel" Margin="5,5,20,5"/>
                                </ScrollViewer>
                                <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="5">
                                    <Button Content="+ Add Parameter"
                                            x:Name="AddActionsParamButton" Click="OnAddActionsParamClick"
                                            TabIndex="23"
                                            Margin="0,0,5,0"/>
                                    <Button Content="ðŸ’¡ Suggest"
                                            x:Name="SuggestActionsParamButton" Click="OnSuggestActionsParamClick"
                                            TabIndex="24"
                                            Margin="0,0,10,0"
                                            ToolTip.Tip="Show available parameter keys and values from script"/>
                                    <CheckBox x:Name="AutoTrimActionsCheckBox"
                                              Content="Auto-Trim whitespace"
                                              IsChecked="True"
                                              IsTabStop="False"
                                              ToolTip.Tip="Automatically trim leading/trailing whitespace from keys and values"/>
                                </StackPanel>
                            </Grid>
                        </Border>

                        <TextBlock Text="Action Script Preview:" Margin="0,5,0,2"/>
                        <Border x:Name="ActionScriptPreviewGrid" MinHeight="100" MaxHeight="150" BorderBrush="Gray" BorderThickness="1" Margin="0,0,0,5">
                            <ScrollViewer x:Name="ActionScriptPreviewScrollViewer"
                                         VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
                                <TextBox x:Name="ActionScriptPreviewTextBox"
                                         FontFamily="Consolas"
                                         Background="Transparent" BorderThickness="0"
                                         IsReadOnly="True" TextWrapping="NoWrap"
                                         IsTabStop="False"
                                         Text="// Action script preview will appear here"
                                         Margin="5"/>
                            </ScrollViewer>
                        </Border>

                        </StackPanel>
                    </ScrollViewer>
                </TabItem>

                <!-- Node Properties Tab -->
                <TabItem Header="Node">
                    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                        <StackPanel Margin="5">
                            <!-- Conversation Settings (shown only for ROOT node) -->
                            <StackPanel x:Name="ConversationSettingsPanel">
                                <TextBlock Text="Conversation Settings" FontWeight="Bold" Margin="0,0,0,5"/>

                            <CheckBox x:Name="PreventZoomCheckBox" Content="Prevent Camera Zoom (Cutscene Mode)"
                                      Margin="0,0,0,5" Checked="OnConversationSettingChanged" Unchecked="OnConversationSettingChanged"
                                      ToolTip.Tip="When checked, prevents camera zoom-in during conversation (useful for cutscenes)"/>

                            <TextBlock Text="On Conversation End (Normal):"/>
                            <Grid Margin="0,0,0,5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="5"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBox x:Name="ScriptEndTextBox" Grid.Column="0" FontFamily="Consolas"
                                         TextWrapping="Wrap" LostFocus="OnConversationSettingChanged"
                                         ToolTip.Tip="Script to run when conversation ends normally"/>
                                <Button Grid.Column="2" Content="Browse..." MinWidth="55" Padding="5,0"
                                        Click="OnBrowseConversationScriptClick" Tag="ScriptEnd"/>
                            </Grid>

                            <TextBlock Text="On Conversation Abort:"/>
                            <Grid Margin="0,0,0,10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="5"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBox x:Name="ScriptAbortTextBox" Grid.Column="0" FontFamily="Consolas"
                                         TextWrapping="Wrap" LostFocus="OnConversationSettingChanged"
                                         ToolTip.Tip="Script to run when conversation is aborted"/>
                                <Button Grid.Column="2" Content="Browse..." MinWidth="55" Padding="5,0"
                                        Click="OnBrowseConversationScriptClick" Tag="ScriptAbort"/>
                            </Grid>

                            <Separator Margin="0,5,0,10"/>
                        </StackPanel>

                        <!-- Node Properties (disabled when no node selected - Issue #3) -->
                        <!-- KeyboardNavigation.TabNavigation="Cycle" ensures Tab wraps within properties panel -->
                        <StackPanel x:Name="NodePropertiesPanel" IsEnabled="{Binding HasNodeSelected}"
                                    KeyboardNavigation.TabNavigation="Cycle">
                            <TextBlock Text="Node Properties" FontWeight="Bold" Margin="0,0,0,10"/>

                            <!-- Basic Node Info (display only) -->
                            <!-- DRAGON: NodeTypeTextBlock x:Name must remain for code-behind references -->
                            <TextBlock x:Name="NodeTypeTextBlock" Text=""
                                       FontStyle="Italic"
                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                       Margin="0,0,0,10"
                                       TextWrapping="Wrap"/>

                            <!-- Animation and Audio -->
                            <Separator Margin="0,5"/>
                            <TextBlock Text="Animation &amp; Audio:" FontWeight="Bold" Margin="0,5,0,5"/>

                            <TextBlock Text="Animation:"/>
                            <ComboBox x:Name="AnimationComboBox" Margin="0,0,0,5"
                                      SelectionChanged="OnAnimationSelectionChanged"/>

                            <TextBlock Text="Sound File:"/>
                            <Grid Margin="0,0,0,5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="5"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="5"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBox x:Name="SoundTextBox" Grid.Column="0" TextWrapping="Wrap"
                                         GotFocus="OnFieldGotFocus"
                                         LostFocus="OnFieldLostFocus"/>
                                <Button x:Name="BrowseSoundButton" Grid.Column="2" Content="Browse..."
                                        MinWidth="55" Padding="5,0" Click="OnBrowseSoundClick"/>
                                <Button x:Name="PlaySoundButton" Grid.Column="4" Content="Play"
                                        MinWidth="40" Padding="5,0" Click="OnPlaySoundClick"/>
                            </Grid>

                            <TextBlock Text="Delay (ms):"/>
                            <TextBox x:Name="DelayTextBox" Margin="0,0,0,10" TextWrapping="Wrap"
                                     GotFocus="OnFieldGotFocus"
                                     TextChanged="OnDelayTextChanged"
                                     LostFocus="OnFieldLostFocus"/>

                            <!-- Quest System -->
                            <Separator Margin="0,5"/>
                            <TextBlock Text="Quest System:" FontWeight="Bold" Margin="0,5,0,5"/>

                            <TextBlock Text="Quest Tag:"/>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                                <ComboBox x:Name="QuestTagComboBox" MinWidth="150"
                                          SelectionChanged="OnQuestTagChanged"
                                          ToolTip.Tip="Select a quest from the module's journal">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding DisplayName}"/>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                                <Button Content="âœ•" Width="24" Height="24" Padding="0" Margin="5,0,0,0"
                                        Click="OnClearQuestTagClick"
                                        ToolTip.Tip="Clear quest tag"/>
                            </StackPanel>

                            <!-- Quest Name Display (read-only info) -->
                            <TextBlock x:Name="QuestNameTextBlock"
                                       Foreground="Gray"
                                       FontStyle="Italic"
                                       Margin="5,0,0,5"
                                       Text=""
                                       TextWrapping="Wrap"/>

                            <TextBlock Text="Quest Entry:"/>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                                <ComboBox x:Name="QuestEntryComboBox" MinWidth="150"
                                          SelectionChanged="OnQuestEntryChanged"
                                          ToolTip.Tip="Select a quest entry">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding DisplayText}"
                                                   ToolTip.Tip="{Binding FullText}"/>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                                <Button Content="âœ•" Width="24" Height="24" Padding="0" Margin="5,0,0,0"
                                        Click="OnClearQuestEntryClick"
                                        ToolTip.Tip="Clear quest entry"/>
                            </StackPanel>

                            <!-- Quest Entry Details (text preview and end status) -->
                            <StackPanel Orientation="Horizontal" Margin="5,0,0,10">
                                <TextBlock x:Name="QuestEntryPreviewTextBlock"
                                           Foreground="Gray"
                                           FontStyle="Italic"
                                           Text=""
                                           TextWrapping="NoWrap"
                                           Margin="0,0,10,0"/>
                                <TextBlock x:Name="QuestEntryEndTextBlock"
                                           Foreground="DarkGreen"
                                           FontWeight="Bold"
                                           Text=""
                                           ToolTip.Tip="This entry marks quest as complete and plays reward sound"/>
                            </StackPanel>

                            <!-- Link Properties -->
                            <Separator Margin="0,5"/>
                            <TextBlock x:Name="IsChildTextBlock"
                                       Foreground="Gray"
                                       FontStyle="Italic"
                                       Margin="0,5,0,10"
                                       Text=""
                                       ToolTip.Tip="Indicates if this node is a child/link appearing under multiple parents"/>

                            <!-- Comment -->
                            <TextBlock Text="Comment:"/>
                            <TextBox x:Name="CommentTextBox" AcceptsReturn="True" MinHeight="50"
                                    TextWrapping="Wrap" Margin="0,0,0,5"
                                    GotFocus="OnFieldGotFocus"
                                    LostFocus="OnFieldLostFocus"/>
                            </StackPanel>
                        </StackPanel>
                    </ScrollViewer>
                </TabItem>

                <!-- Scrap Tab - Holds deleted/cut nodes -->
                <TabItem x:Name="ScrapTab" Header="{Binding ScrapTabHeader}">

                    <DockPanel Margin="5">
                        <!-- Scrap Controls -->
                        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="0,0,0,5">
                            <Button x:Name="RestoreScrapButton"
                                    Content="Restore"
                                    Click="OnRestoreScrapClick"
                                    Padding="8,3"
                                    MinWidth="70"
                                    IsEnabled="{Binding CanRestoreFromScrap}"/>
                            <Button x:Name="ClearScrapButton"
                                    Content="Clear All"
                                    Click="OnClearScrapClick"
                                    Padding="8,3"
                                    MinWidth="70"
                                    Margin="5,0,0,0"/>
                            <TextBlock Text="(Auto-clears after 30 days)"
                                      VerticalAlignment="Center"
                                      Foreground="Gray"
                                      FontSize="11"
                                      Margin="10,0,0,0"/>
                        </StackPanel>

                        <!-- Scrap List -->
                        <Border BorderBrush="Gray" BorderThickness="1" Padding="5">
                            <ListBox x:Name="ScrapListBox"
                                     ItemsSource="{Binding ScrapEntries}"
                                     SelectedItem="{Binding SelectedScrapEntry}"
                                     Background="Transparent"
                                     ScrollViewer.VerticalScrollBarVisibility="Auto"
                                     ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                                <ListBox.Styles>
                                    <Style Selector="ListBoxItem">
                                        <Setter Property="Padding" Value="4,2"/>
                                        <Setter Property="Cursor" Value="Hand"/>
                                    </Style>
                                    <Style Selector="ListBoxItem:pointerover">
                                        <Setter Property="Background" Value="#20FFFFFF"/>
                                    </Style>
                                    <Style Selector="ListBoxItem:selected">
                                        <Setter Property="Background" Value="#30007ACC"/>
                                    </Style>
                                </ListBox.Styles>
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Border Padding="4,2">
                                            <StackPanel>
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="{Binding NodeTypeDisplay}"
                                                              FontWeight="Bold"
                                                              Foreground="{DynamicResource SystemAccentColor}"
                                                              Margin="0,0,8,0"/>
                                                    <TextBlock Text="{Binding NodeText}"
                                                              TextTrimming="CharacterEllipsis"/>
                                                </StackPanel>
                                                <StackPanel Orientation="Horizontal" Margin="0,2,0,0">
                                                    <TextBlock Text="{Binding HierarchyInfo}"
                                                              Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                                              FontSize="11"
                                                              Margin="0,0,8,0"/>
                                                    <TextBlock Text="{Binding Speaker}"
                                                              Foreground="Gray"
                                                              FontSize="11"
                                                              Margin="0,0,8,0"
                                                              IsVisible="{Binding Speaker, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                                                    <TextBlock Text="{Binding TimeAgo}"
                                                              Foreground="Gray"
                                                              FontSize="11"
                                                              FontStyle="Italic"/>
                                                </StackPanel>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Border>
                    </DockPanel>
                </TabItem>

                <!-- Debug Output Tab -->
                <TabItem Header="Debug" x:Name="DebugTab" IsVisible="False">
                    <DockPanel Margin="5">
                        <!-- Debug Controls -->
                        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="0,0,0,5">
                            <Button Content="Clear" Click="OnClearDebugClick" Padding="8,3" MinWidth="70"/>
                            <TextBlock Text="Filter:" VerticalAlignment="Center" Margin="15,0,5,0"/>
                            <ComboBox x:Name="LogLevelFilterComboBox"
                                     SelectedIndex="2"
                                     MinWidth="100"
                                     SelectionChanged="OnLogLevelFilterChanged">
                                <ComboBoxItem Content="Error"/>
                                <ComboBoxItem Content="Warning"/>
                                <ComboBoxItem Content="Info"/>
                                <ComboBoxItem Content="Debug"/>
                                <ComboBoxItem Content="Trace"/>
                            </ComboBox>
                            <TextBlock Text="(Last 1000 entries)" VerticalAlignment="Center"
                                      Foreground="Gray" FontSize="11" Margin="10,0,0,0"/>
                        </StackPanel>


                        <!-- Debug ListBox (virtualized by default for performance) -->
                        <Border BorderBrush="Gray" BorderThickness="1" Padding="5">
                            <ListBox x:Name="DebugListBox"
                                     ItemsSource="{Binding DebugMessages}"
                                     Background="Transparent"
                                     ScrollViewer.VerticalScrollBarVisibility="Auto">
                                <ListBox.Styles>
                                    <Style Selector="ListBoxItem">
                                        <Setter Property="Padding" Value="2,0"/>
                                        <Setter Property="MinHeight" Value="0"/>
                                    </Style>
                                </ListBox.Styles>
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding}" FontFamily="Consolas" Padding="0"/>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Border>
                    </DockPanel>
                </TabItem>
            </TabControl>

            <!-- Flowchart Splitter (Side-by-Side mode) -->
            <GridSplitter x:Name="FlowchartSplitter"
                          Grid.Row="0" Grid.RowSpan="3" Grid.Column="3"
                          Width="5" HorizontalAlignment="Stretch"
                          ResizeDirection="Columns" Background="Gray"
                          IsVisible="False"/>

            <!-- Embedded Flowchart Panel (Side-by-Side mode) -->
            <Border x:Name="EmbeddedFlowchartBorder"
                    Grid.Row="0" Grid.RowSpan="3" Grid.Column="4"
                    BorderBrush="Gray" BorderThickness="1" Margin="0,5,5,5"
                    IsVisible="False">
                <views:FlowchartPanel x:Name="EmbeddedFlowchartPanel"/>
            </Border>
        </Grid>

        <!-- Status Bar -->
        <Border Grid.Row="7" BorderBrush="Gray" BorderThickness="0,1,0,0" Padding="5,2">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="{Binding StatusMessage}"/>
                <TextBlock Grid.Column="1" Text="{Binding LastSavedTime}" Foreground="{DynamicResource SystemAccentColor}" FontStyle="Italic" Margin="20,0,0,0"/>
                <TextBlock Grid.Column="2" Text="{Binding LoadedFileName}" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" Margin="20,0,0,0"/>
                <ProgressBar Grid.Column="3" Width="100" Height="16"
                             IsIndeterminate="{Binding IsLoading}"
                             IsVisible="{Binding IsLoading}" Margin="10,0,0,0"/>
            </Grid>
        </Border>
    </Grid>
</Window>
