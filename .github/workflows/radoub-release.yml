name: Radoub Bundle Release

on:
  push:
    tags:
      - 'radoub-v*'

permissions:
  contents: write  # Required to create releases

jobs:
  build-parley:
    strategy:
      matrix:
        include:
          - os: windows-latest
            runtime: win-x64
            artifact-name: Parley-win-x64
            self-contained: true
          - os: macos-latest
            runtime: osx-arm64
            artifact-name: Parley-osx-arm64
            self-contained: true
          - os: ubuntu-latest
            runtime: linux-x64
            artifact-name: Parley-linux-x64
            self-contained: true

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '9.0.x'

    - name: Extract Version from Tag
      id: version
      shell: bash
      run: |
        TAG="${GITHUB_REF#refs/tags/}"
        VERSION="${TAG#radoub-v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=$TAG" >> $GITHUB_OUTPUT

    - name: Restore dependencies
      run: dotnet restore Parley/Parley.csproj -r ${{ matrix.runtime }}
      working-directory: ./Parley

    - name: Build project
      run: dotnet build Parley/Parley.csproj --configuration Release --no-restore -r ${{ matrix.runtime }} -p:Version=${{ steps.version.outputs.version }}
      working-directory: ./Parley

    # Windows: PublishSingleFile disabled because CEF subprocess requires separate DLLs
    - name: Publish (Windows)
      if: matrix.os == 'windows-latest'
      run: dotnet publish Parley/Parley.csproj -c Release -r ${{ matrix.runtime }} --self-contained true -p:PublishReadyToRun=true -p:Version=${{ steps.version.outputs.version }} -o ./publish/Parley
      working-directory: ./Parley

    # macOS/Linux: Use PublishSingleFile
    - name: Publish (macOS/Linux)
      if: matrix.os != 'windows-latest'
      run: dotnet publish Parley/Parley.csproj -c Release -r ${{ matrix.runtime }} --self-contained true -p:PublishSingleFile=true -p:PublishReadyToRun=true -p:IncludeNativeLibrariesForSelfExtract=true -p:Version=${{ steps.version.outputs.version }} -o ./publish/Parley
      working-directory: ./Parley

    - name: Upload Parley artifact
      uses: actions/upload-artifact@v6
      with:
        name: parley-${{ matrix.runtime }}
        path: Parley/publish/Parley

  build-manifest:
    strategy:
      matrix:
        include:
          - os: windows-latest
            runtime: win-x64
            artifact-name: Manifest-win-x64
            self-contained: true
          - os: macos-latest
            runtime: osx-arm64
            artifact-name: Manifest-osx-arm64
            self-contained: true
          - os: ubuntu-latest
            runtime: linux-x64
            artifact-name: Manifest-linux-x64
            self-contained: true

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '9.0.x'

    - name: Extract Version from Tag
      id: version
      shell: bash
      run: |
        TAG="${GITHUB_REF#refs/tags/}"
        VERSION="${TAG#radoub-v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=$TAG" >> $GITHUB_OUTPUT

    - name: Restore dependencies
      run: dotnet restore Manifest/Manifest/Manifest.csproj -r ${{ matrix.runtime }}

    - name: Build project
      run: dotnet build Manifest/Manifest/Manifest.csproj --configuration Release --no-restore -r ${{ matrix.runtime }} -p:Version=${{ steps.version.outputs.version }}

    - name: Publish
      run: dotnet publish Manifest/Manifest/Manifest.csproj -c Release -r ${{ matrix.runtime }} --self-contained true -p:PublishSingleFile=true -p:PublishReadyToRun=true -p:IncludeNativeLibrariesForSelfExtract=true -p:Version=${{ steps.version.outputs.version }} -o ./publish/Manifest

    - name: Upload Manifest artifact
      uses: actions/upload-artifact@v6
      with:
        name: manifest-${{ matrix.runtime }}
        path: ./publish/Manifest

  bundle-and-release:
    needs: [build-parley, build-manifest]
    strategy:
      matrix:
        include:
          - os: windows-latest
            runtime: win-x64
            bundle-name: Radoub-win-x64
            archive-ext: zip
          - os: macos-latest
            runtime: osx-arm64
            bundle-name: Radoub-osx-arm64
            archive-ext: zip
          - os: ubuntu-latest
            runtime: linux-x64
            bundle-name: Radoub-linux-x64
            archive-ext: tar.gz

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Extract Version from Tag
      id: version
      shell: bash
      run: |
        TAG="${GITHUB_REF#refs/tags/}"
        VERSION="${TAG#radoub-v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=$TAG" >> $GITHUB_OUTPUT

    - name: Download Parley artifact
      uses: actions/download-artifact@v7
      with:
        name: parley-${{ matrix.runtime }}
        path: ./bundle/Parley

    - name: Download Manifest artifact
      uses: actions/download-artifact@v7
      with:
        name: manifest-${{ matrix.runtime }}
        path: ./bundle/Manifest

    - name: Display bundle structure
      shell: bash
      run: |
        echo "Bundle contents:"
        find ./bundle -type f 2>/dev/null | head -50 || true

    # macOS: Create .app bundles
    - name: Create macOS App Bundles
      if: matrix.os == 'macos-latest'
      shell: bash
      run: |
        # Parley.app
        mkdir -p "./bundle/Parley.app/Contents/MacOS"
        mkdir -p "./bundle/Parley.app/Contents/Resources"
        mv ./bundle/Parley/Parley "./bundle/Parley.app/Contents/MacOS/"
        mv ./bundle/Parley/*.dylib "./bundle/Parley.app/Contents/MacOS/" 2>/dev/null || true
        cat > "./bundle/Parley.app/Contents/Info.plist" << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>Parley</string>
            <key>CFBundleIdentifier</key>
            <string>com.lnsdevelopment.parley</string>
            <key>CFBundleName</key>
            <string>Parley</string>
            <key>CFBundleVersion</key>
            <string>${{ steps.version.outputs.version }}</string>
            <key>CFBundleShortVersionString</key>
            <string>${{ steps.version.outputs.version }}</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>NSHighResolutionCapable</key>
            <true/>
        </dict>
        </plist>
        EOF
        chmod +x "./bundle/Parley.app/Contents/MacOS/Parley"
        rm -rf ./bundle/Parley

        # Manifest.app
        mkdir -p "./bundle/Manifest.app/Contents/MacOS"
        mkdir -p "./bundle/Manifest.app/Contents/Resources"
        mv ./bundle/Manifest/Manifest "./bundle/Manifest.app/Contents/MacOS/"
        mv ./bundle/Manifest/*.dylib "./bundle/Manifest.app/Contents/MacOS/" 2>/dev/null || true
        cat > "./bundle/Manifest.app/Contents/Info.plist" << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>Manifest</string>
            <key>CFBundleIdentifier</key>
            <string>com.lnsdevelopment.manifest</string>
            <key>CFBundleName</key>
            <string>Manifest</string>
            <key>CFBundleVersion</key>
            <string>${{ steps.version.outputs.version }}</string>
            <key>CFBundleShortVersionString</key>
            <string>${{ steps.version.outputs.version }}</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>NSHighResolutionCapable</key>
            <true/>
        </dict>
        </plist>
        EOF
        chmod +x "./bundle/Manifest.app/Contents/MacOS/Manifest"
        rm -rf ./bundle/Manifest

    # Linux: Make executables
    - name: Set Linux permissions
      if: matrix.os == 'ubuntu-latest'
      shell: bash
      run: |
        chmod +x ./bundle/Parley/Parley
        chmod +x ./bundle/Manifest/Manifest

    # Package bundle
    - name: Package Windows Bundle
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        cd ./bundle
        Compress-Archive -Path "*" -DestinationPath "../${{ matrix.bundle-name }}.zip"
        Write-Host "Created: ${{ matrix.bundle-name }}.zip"

    - name: Package macOS Bundle
      if: matrix.os == 'macos-latest'
      shell: bash
      run: |
        cd ./bundle
        zip -r ../${{ matrix.bundle-name }}.zip .
        echo "Created: ${{ matrix.bundle-name }}.zip"

    - name: Package Linux Bundle
      if: matrix.os == 'ubuntu-latest'
      shell: bash
      run: |
        cd ./bundle
        tar -czf ../${{ matrix.bundle-name }}.tar.gz .
        echo "Created: ${{ matrix.bundle-name }}.tar.gz"

    - name: Upload bundle artifact
      uses: actions/upload-artifact@v6
      with:
        name: ${{ matrix.bundle-name }}
        path: |
          ${{ matrix.bundle-name }}.zip
          ${{ matrix.bundle-name }}.tar.gz
        if-no-files-found: ignore

  create-release:
    needs: bundle-and-release
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Extract Version from Tag
      id: version
      shell: bash
      run: |
        TAG="${GITHUB_REF#refs/tags/}"
        VERSION="${TAG#radoub-v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=$TAG" >> $GITHUB_OUTPUT

    - name: Download all artifacts
      uses: actions/download-artifact@v7
      with:
        path: ./artifacts

    - name: Display artifact structure
      run: |
        echo "Artifacts downloaded:"
        find ./artifacts -type f

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ./artifacts/**/*.zip
          ./artifacts/**/*.tar.gz
        body: |
          # Radoub ${{ steps.version.outputs.version }}

          Bundled release containing Parley and Manifest editors.

          ## Downloads

          ### Recommended (No .NET Required)

          These bundles include everything needed - just download and run!

          - **Windows**: `Radoub-win-x64.zip` (~150MB)
            - Extract and run `Parley/Parley.exe` or `Manifest/Manifest.exe`
          - **macOS**: `Radoub-osx-arm64.zip` (~160MB)
            - Extract and open `Parley.app` or `Manifest.app`
            - Apple Silicon (M1/M2/M3) Macs
          - **Linux**: `Radoub-linux-x64.tar.gz` (~145MB)
            - Extract and run `./Parley/Parley` or `./Manifest/Manifest`

          ## What's Included

          | Tool | Description |
          |------|-------------|
          | **Parley** | Dialog editor for `.dlg` files |
          | **Manifest** | Journal editor for `.jrl` files |

          ## Shared Infrastructure

          Both tools share:
          - .NET 9 runtime
          - Avalonia UI framework
          - Radoub.Formats library
          - Cross-tool discovery (launch Manifest from Parley's Quest Browser)

          ## Standalone Downloads

          Individual tools are also available as separate releases:
          - [Parley Releases](https://github.com/${{ github.repository }}/releases?q=v&expanded=true)
          - [Manifest Releases](https://github.com/${{ github.repository }}/releases?q=manifest-v&expanded=true)

          ## Changes

          See the individual changelogs:
          - [Parley CHANGELOG](https://github.com/${{ github.repository }}/blob/main/Parley/CHANGELOG.md)
          - [Manifest CHANGELOG](https://github.com/${{ github.repository }}/blob/main/Manifest/CHANGELOG.md)

          ## Installation Notes

          **macOS**: You may need to allow the apps in System Preferences â†’ Security & Privacy after first launch.

          **Linux**: Make binaries executable: `chmod +x Parley/Parley Manifest/Manifest`

          ---
          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
