name: Radoub Bundle Release

on:
  push:
    tags:
      - 'radoub-v*'

permissions:
  contents: write  # Required to create releases

jobs:
  build-bundle:
    strategy:
      matrix:
        include:
          - os: windows-latest
            runtime: win-x64
            bundle-name: Radoub-win-x64
            archive-ext: zip
          - os: macos-latest
            runtime: osx-arm64
            bundle-name: Radoub-osx-arm64
            archive-ext: zip
          - os: ubuntu-latest
            runtime: linux-x64
            bundle-name: Radoub-linux-x64
            archive-ext: tar.gz

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '9.0.x'

    - name: Extract Version from Tag
      id: version
      shell: bash
      run: |
        TAG="${GITHUB_REF#refs/tags/}"
        VERSION="${TAG#radoub-v}"
        COMMIT=$(git rev-parse --short=7 HEAD)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "commit=$COMMIT" >> $GITHUB_OUTPUT

    - name: Restore Parley dependencies
      run: dotnet restore Parley/Parley/Parley.csproj -r ${{ matrix.runtime }}

    - name: Restore Manifest dependencies
      run: dotnet restore Manifest/Manifest/Manifest.csproj -r ${{ matrix.runtime }}

    - name: Restore Fence dependencies
      run: dotnet restore Fence/Fence/Fence.csproj -r ${{ matrix.runtime }}

    # Publish all tools to the SAME output folder - DLLs are automatically shared
    # Parley first (larger, has more dependencies including CEF)
    # IncludePlugins=false excludes plugin SDK files from bundle (plugins not ready for release)
    # InformationalVersion overrides GitInfo's auto-generated version with version+commit
    - name: Publish Parley to shared folder
      run: dotnet publish Parley/Parley/Parley.csproj -c Release -r ${{ matrix.runtime }} --self-contained true -p:PublishReadyToRun=true -p:IncludePlugins=false -p:Version=${{ steps.version.outputs.version }} -p:InformationalVersion=${{ steps.version.outputs.version }}+${{ steps.version.outputs.commit }} -o ./publish/Radoub

    # Manifest - only adds Manifest.exe and Manifest-specific files, DLLs already present
    - name: Publish Manifest to shared folder
      run: dotnet publish Manifest/Manifest/Manifest.csproj -c Release -r ${{ matrix.runtime }} --self-contained true -p:PublishReadyToRun=true -p:Version=${{ steps.version.outputs.version }} -p:InformationalVersion=${{ steps.version.outputs.version }}+${{ steps.version.outputs.commit }} -o ./publish/Radoub

    # Fence - merchant/store editor
    - name: Publish Fence to shared folder
      run: dotnet publish Fence/Fence/Fence.csproj -c Release -r ${{ matrix.runtime }} --self-contained true -p:PublishReadyToRun=true -p:Version=${{ steps.version.outputs.version }} -p:InformationalVersion=${{ steps.version.outputs.version }}+${{ steps.version.outputs.commit }} -o ./publish/Radoub

    - name: Display bundle structure
      shell: bash
      run: |
        echo "Bundle contents:"
        ls -la ./publish/Radoub/ | head -30 || true
        echo ""
        echo "Total size:"
        du -sh ./publish/Radoub/ || dir ./publish/Radoub/

    # macOS: Create .app bundles in a Radoub folder
    - name: Create macOS App Bundles
      if: matrix.os == 'macos-latest'
      shell: bash
      run: |
        mkdir -p ./bundle

        # Parley.app - copy from shared folder
        mkdir -p "./bundle/Parley.app/Contents/MacOS"
        mkdir -p "./bundle/Parley.app/Contents/Resources"
        cp ./publish/Radoub/Parley "./bundle/Parley.app/Contents/MacOS/"
        cp ./publish/Radoub/*.dylib "./bundle/Parley.app/Contents/MacOS/" 2>/dev/null || true
        cat > "./bundle/Parley.app/Contents/Info.plist" << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>Parley</string>
            <key>CFBundleIdentifier</key>
            <string>com.lnsdevelopment.parley</string>
            <key>CFBundleName</key>
            <string>Parley</string>
            <key>CFBundleVersion</key>
            <string>${{ steps.version.outputs.version }}</string>
            <key>CFBundleShortVersionString</key>
            <string>${{ steps.version.outputs.version }}</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>NSHighResolutionCapable</key>
            <true/>
        </dict>
        </plist>
        EOF
        chmod +x "./bundle/Parley.app/Contents/MacOS/Parley"

        # Manifest.app - copy from shared folder
        mkdir -p "./bundle/Manifest.app/Contents/MacOS"
        mkdir -p "./bundle/Manifest.app/Contents/Resources"
        cp ./publish/Radoub/Manifest "./bundle/Manifest.app/Contents/MacOS/"
        cp ./publish/Radoub/*.dylib "./bundle/Manifest.app/Contents/MacOS/" 2>/dev/null || true
        cat > "./bundle/Manifest.app/Contents/Info.plist" << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>Manifest</string>
            <key>CFBundleIdentifier</key>
            <string>com.lnsdevelopment.manifest</string>
            <key>CFBundleName</key>
            <string>Manifest</string>
            <key>CFBundleVersion</key>
            <string>${{ steps.version.outputs.version }}</string>
            <key>CFBundleShortVersionString</key>
            <string>${{ steps.version.outputs.version }}</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>NSHighResolutionCapable</key>
            <true/>
        </dict>
        </plist>
        EOF
        chmod +x "./bundle/Manifest.app/Contents/MacOS/Manifest"

        # Fence.app - copy from shared folder
        mkdir -p "./bundle/Fence.app/Contents/MacOS"
        mkdir -p "./bundle/Fence.app/Contents/Resources"
        cp ./publish/Radoub/Fence "./bundle/Fence.app/Contents/MacOS/"
        cp ./publish/Radoub/*.dylib "./bundle/Fence.app/Contents/MacOS/" 2>/dev/null || true
        cat > "./bundle/Fence.app/Contents/Info.plist" << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>Fence</string>
            <key>CFBundleIdentifier</key>
            <string>com.lnsdevelopment.fence</string>
            <key>CFBundleName</key>
            <string>Fence</string>
            <key>CFBundleVersion</key>
            <string>${{ steps.version.outputs.version }}</string>
            <key>CFBundleShortVersionString</key>
            <string>${{ steps.version.outputs.version }}</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>NSHighResolutionCapable</key>
            <true/>
        </dict>
        </plist>
        EOF
        chmod +x "./bundle/Fence.app/Contents/MacOS/Fence"

    # Linux: Make executables
    - name: Set Linux permissions
      if: matrix.os == 'ubuntu-latest'
      shell: bash
      run: |
        chmod +x ./publish/Radoub/Parley
        chmod +x ./publish/Radoub/Manifest
        chmod +x ./publish/Radoub/Fence

    # Package bundle - Windows/Linux use the shared folder directly
    - name: Package Windows Bundle
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        cd ./publish
        Compress-Archive -Path "Radoub" -DestinationPath "../${{ matrix.bundle-name }}.zip"
        Write-Host "Created: ${{ matrix.bundle-name }}.zip"

    - name: Package macOS Bundle
      if: matrix.os == 'macos-latest'
      shell: bash
      run: |
        cd ./bundle
        zip -r ../${{ matrix.bundle-name }}.zip .
        echo "Created: ${{ matrix.bundle-name }}.zip"

    - name: Package Linux Bundle
      if: matrix.os == 'ubuntu-latest'
      shell: bash
      run: |
        cd ./publish
        tar -czf ../${{ matrix.bundle-name }}.tar.gz Radoub
        echo "Created: ${{ matrix.bundle-name }}.tar.gz"

    - name: Upload bundle artifact
      uses: actions/upload-artifact@v6
      with:
        name: ${{ matrix.bundle-name }}
        path: |
          ${{ matrix.bundle-name }}.zip
          ${{ matrix.bundle-name }}.tar.gz
        if-no-files-found: ignore

  create-release:
    needs: build-bundle
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Extract Version from Tag
      id: version
      shell: bash
      run: |
        TAG="${GITHUB_REF#refs/tags/}"
        VERSION="${TAG#radoub-v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=$TAG" >> $GITHUB_OUTPUT

    - name: Extract Changelog Highlights
      id: highlights
      shell: bash
      run: |
        # Check for manually curated release notes first (created by /release command)
        if [ -f "release-notes.md" ]; then
          echo "Using curated release-notes.md"
          cp release-notes.md highlights.md
        else
          # Fallback: auto-extract from tool changelogs
          extract_changelog_section() {
            local file="$1"
            local tool_name="$2"

            if [ ! -f "$file" ]; then
              echo "### $tool_name"
              echo "_No changelog found_"
              echo ""
              return
            fi

            # Find the first versioned section (skip [Unreleased])
            local section=$(awk '
              /^## \[[0-9]/ { if (found) exit; found=1; next }
              found && /^## \[/ { exit }
              found { print }
            ' "$file")

            if [ -n "$section" ]; then
              echo "### $tool_name"
              # Extract just the key points - lines starting with - or ###
              echo "$section" | grep -E "^(###|- \[?x?\]?)" | head -15 | sed 's/^### /#### /'
              echo ""
            fi
          }

          {
            echo "## Highlights"
            echo ""
            extract_changelog_section "Parley/CHANGELOG.md" "Parley"
            extract_changelog_section "Manifest/CHANGELOG.md" "Manifest"
            extract_changelog_section "Fence/CHANGELOG.md" "Fence"
          } > highlights.md
        fi

        # Store as multiline output
        {
          echo 'highlights<<EOF'
          cat highlights.md
          echo 'EOF'
        } >> $GITHUB_OUTPUT

    - name: Download all artifacts
      uses: actions/download-artifact@v7
      with:
        path: ./artifacts

    - name: Display artifact structure
      run: |
        echo "Artifacts downloaded:"
        find ./artifacts -type f

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ./artifacts/**/*.zip
          ./artifacts/**/*.tar.gz
        body: |
          # Radoub ${{ steps.version.outputs.version }}

          Bundled release containing Parley, Manifest, and Fence editors with shared runtime.

          ${{ steps.highlights.outputs.highlights }}

          ## Downloads

          ### Recommended (No .NET Required)

          These bundles include everything needed - just download and run!

          - **Windows**: `Radoub-win-x64.zip` (~110MB)
            - Extract and run `Radoub/Parley.exe`, `Radoub/Manifest.exe`, or `Radoub/Fence.exe`
          - **macOS**: `Radoub-osx-arm64.zip` (~120MB)
            - Extract and open `Parley.app`, `Manifest.app`, or `Fence.app`
            - Apple Silicon (M1/M2/M3) Macs
          - **Linux**: `Radoub-linux-x64.tar.gz` (~105MB)
            - Extract and run `./Radoub/Parley`, `./Radoub/Manifest`, or `./Radoub/Fence`

          ## What's Included

          | Tool | Description |
          |------|-------------|
          | **Parley** | Dialog editor for `.dlg` files |
          | **Manifest** | Journal editor for `.jrl` files |
          | **Fence** | Merchant/store editor for `.utm` files |

          ## Shared Infrastructure

          All tools share a single folder with common dependencies:
          - .NET 9 runtime (shared, not duplicated)
          - Avalonia UI framework
          - Radoub.Formats library
          - Radoub.UI shared components
          - Cross-tool discovery (launch Manifest from Parley's Quest Browser)

          ## Standalone Downloads

          Individual tools are also available as separate releases:
          - [Parley Releases](https://github.com/${{ github.repository }}/releases?q=v&expanded=true)
          - [Manifest Releases](https://github.com/${{ github.repository }}/releases?q=manifest-v&expanded=true)

          ## Changes

          See the individual changelogs:
          - [Parley CHANGELOG](https://github.com/${{ github.repository }}/blob/main/Parley/CHANGELOG.md)
          - [Manifest CHANGELOG](https://github.com/${{ github.repository }}/blob/main/Manifest/CHANGELOG.md)
          - [Fence CHANGELOG](https://github.com/${{ github.repository }}/blob/main/Fence/CHANGELOG.md)

          ## Installation Notes

          **macOS**: You may need to allow the apps in System Preferences â†’ Security & Privacy after first launch.

          **Linux**: Make binaries executable: `chmod +x Radoub/Parley Radoub/Manifest Radoub/Fence`

          ---
          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
