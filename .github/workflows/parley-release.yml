name: Release Build

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # Required to create releases

jobs:
  build-and-release:
    strategy:
      matrix:
        include:
          # Self-contained builds (recommended for users)
          - os: windows-latest
            runtime: win-x64
            artifact-name: Parley-win-x64
            output-ext: .exe
            self-contained: true
          - os: macos-latest
            runtime: osx-arm64
            artifact-name: Parley-osx-arm64
            output-ext: ''
            self-contained: true
          - os: ubuntu-latest
            runtime: linux-x64
            artifact-name: Parley-linux-x64
            output-ext: ''
            self-contained: true
          # Framework-dependent builds (smaller, requires .NET 9)
          - os: windows-latest
            runtime: win-x64
            artifact-name: Parley-win-x64-fd
            output-ext: .exe
            self-contained: false
          - os: macos-latest
            runtime: osx-arm64
            artifact-name: Parley-osx-arm64-fd
            output-ext: ''
            self-contained: false
          - os: ubuntu-latest
            runtime: linux-x64
            artifact-name: Parley-linux-x64-fd
            output-ext: ''
            self-contained: false

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0  # GitVersion needs full history

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '9.0.x'

    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v4
      with:
        versionSpec: '6.x'

    - name: Determine Version
      id: gitversion
      uses: gittools/actions/gitversion/execute@v4

    - name: Display GitVersion outputs
      shell: bash
      run: |
        echo "SemVer: ${{ steps.gitversion.outputs.semVer }}"
        echo "FullSemVer: ${{ steps.gitversion.outputs.fullSemVer }}"

    - name: Restore dependencies
      run: dotnet restore Parley/Parley.csproj -r ${{ matrix.runtime }}
      working-directory: ./Parley

    - name: Build project
      run: dotnet build Parley/Parley.csproj --configuration Release --no-restore -r ${{ matrix.runtime }} -p:Version=${{ steps.gitversion.outputs.assemblySemVer }} -p:FileVersion=${{ steps.gitversion.outputs.assemblySemFileVer }} -p:InformationalVersion=${{ steps.gitversion.outputs.informationalVersion }}
      working-directory: ./Parley

    - name: Run tests
      shell: bash
      run: |
        if [ -d "TestingTools" ]; then
          for project in $(find TestingTools -name "*.csproj"); do
            echo "Testing: $project"
            dotnet test "$project" --configuration Release --no-build --verbosity normal || exit 1
          done
          echo "âœ… All tests passed"
        else
          echo "âš ï¸ No tests found, skipping"
        fi
      working-directory: ./Parley

    # Note: PublishSingleFile disabled because CEF subprocess (CefGlueBrowserProcess)
    # requires its .dll files to remain separate - they can't be bundled (#314)
    - name: Publish (Self-Contained)
      if: matrix.self-contained == true
      run: dotnet publish Parley/Parley.csproj -c Release -r ${{ matrix.runtime }} --self-contained true -p:PublishReadyToRun=true -p:Version=${{ steps.gitversion.outputs.assemblySemVer }} -o ./publish/${{ matrix.artifact-name }}
      working-directory: ./Parley

    - name: Publish (Framework-Dependent)
      if: matrix.self-contained == false
      run: dotnet publish Parley/Parley.csproj -c Release -r ${{ matrix.runtime }} --self-contained false -p:Version=${{ steps.gitversion.outputs.assemblySemVer }} -o ./publish/${{ matrix.artifact-name }}
      working-directory: ./Parley

    # macOS: Create .app bundle for self-contained builds
    - name: Create macOS App Bundle
      if: matrix.os == 'macos-latest' && matrix.self-contained == true
      shell: bash
      run: |
        APP_NAME="Parley.app"
        BUNDLE_DIR="./publish/${{ matrix.artifact-name }}/$APP_NAME"

        mkdir -p "$BUNDLE_DIR/Contents/MacOS"
        mkdir -p "$BUNDLE_DIR/Contents/Resources"

        # Move all published files into app bundle
        mv ./publish/${{ matrix.artifact-name }}/Parley "$BUNDLE_DIR/Contents/MacOS/"
        mv ./publish/${{ matrix.artifact-name }}/*.dylib "$BUNDLE_DIR/Contents/MacOS/" 2>/dev/null || true

        # Create Info.plist
        cat > "$BUNDLE_DIR/Contents/Info.plist" << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>Parley</string>
            <key>CFBundleIdentifier</key>
            <string>com.lnsdevelopment.parley</string>
            <key>CFBundleName</key>
            <string>Parley</string>
            <key>CFBundleVersion</key>
            <string>${{ steps.gitversion.outputs.semVer }}</string>
            <key>CFBundleShortVersionString</key>
            <string>${{ steps.gitversion.outputs.semVer }}</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>NSHighResolutionCapable</key>
            <true/>
        </dict>
        </plist>
        EOF

        # Make executable
        chmod +x "$BUNDLE_DIR/Contents/MacOS/Parley"
      working-directory: ./Parley

    # Package artifacts
    - name: Package Windows Build
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        cd "./publish/${{ matrix.artifact-name }}"
        $archiveName = "../../${{ matrix.artifact-name }}.zip"
        Compress-Archive -Path "*" -DestinationPath $archiveName
        Write-Host "Created: ${{ matrix.artifact-name }}.zip"
      working-directory: ./Parley

    - name: Package macOS Build
      if: matrix.os == 'macos-latest'
      shell: bash
      run: |
        cd ./publish/${{ matrix.artifact-name }}
        zip -r ../../${{ matrix.artifact-name }}.zip .
        echo "Created: ${{ matrix.artifact-name }}.zip"
      working-directory: ./Parley

    - name: Package Linux Build
      if: matrix.os == 'ubuntu-latest'
      shell: bash
      run: |
        cd ./publish/${{ matrix.artifact-name }}
        tar -czf ../../${{ matrix.artifact-name }}.tar.gz .
        echo "Created: ${{ matrix.artifact-name }}.tar.gz"
      working-directory: ./Parley

    # Upload artifacts for release
    - name: Upload artifact
      uses: actions/upload-artifact@v5
      with:
        name: ${{ matrix.artifact-name }}
        path: |
          Parley/${{ matrix.artifact-name }}.zip
          Parley/${{ matrix.artifact-name }}.tar.gz
        if-no-files-found: ignore

  create-release:
    needs: build-and-release
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v4
      with:
        versionSpec: '6.x'

    - name: Determine Version
      id: gitversion
      uses: gittools/actions/gitversion/execute@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v6
      with:
        path: ./artifacts

    - name: Display artifact structure
      run: |
        echo "Artifacts downloaded:"
        find ./artifacts -type f

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ./artifacts/**/*.zip
          ./artifacts/**/*.tar.gz
        body: |
          # Parley ${{ steps.gitversion.outputs.semVer }}

          Dialog editor for Neverwinter Nights `.dlg` files.

          ## Downloads

          ### Recommended (No .NET Required)

          These bundles include everything needed to run Parley - just download and run!

          **Note:** The Flowchart View plugin requires [Python 3.10+](https://www.python.org/downloads/) with `grpcio` and `protobuf` packages installed:
          ```
          pip install grpcio protobuf
          ```

          - **Windows**: `Parley-win-x64.zip` (~130MB)
            - Extract and run `Parley.exe`
          - **macOS**: `Parley-osx-arm64.zip` (~148MB)
            - Extract and open `Parley.app`
            - Apple Silicon (M1/M2/M3) Macs
          - **Linux**: `Parley-linux-x64.tar.gz` (~125MB)
            - Extract and run `./Parley`

          ### Advanced (Requires .NET 9 Runtime)

          Smaller downloads for users who already have [.NET 9 Runtime](https://dotnet.microsoft.com/download/dotnet/9.0) installed:

          - **Windows**: `Parley-win-x64-fd.zip` (~8MB)
          - **macOS**: `Parley-osx-arm64-fd.zip` (~8MB)
          - **Linux**: `Parley-linux-x64-fd.tar.gz` (~8MB)

          ## Included Plugins

          - **Flowchart View** - ChatMapper-style visual dialog graph (requires Python 3.10+)

          Plugins are located in the `Plugins/Official/` folder. Enable them via Settings â†’ Plugins.

          ## Changes

          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/Parley/CHANGELOG.md) for detailed changes.

          ## Installation Notes

          **macOS**: You may need to allow the app in System Preferences â†’ Security & Privacy after first launch.

          **Linux**: Make the binary executable: `chmod +x Parley`

          ---
          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
